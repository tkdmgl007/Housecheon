<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ë¹Œë¼ê´€ë¦¬ v6</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,sans-serif;background:#e0f7fa;min-height:100vh}.header{background:linear-gradient(90deg,#00695c,#00897b);color:#fff;padding:14px 16px;position:sticky;top:0;z-index:100}.tabs{display:flex;background:#004d40}.tab{flex:1;padding:12px;text-align:center;color:#fff;border:none;background:0 0;font-size:11px;cursor:pointer;border-bottom:3px solid transparent}.tab.active{background:#00796b;border-bottom-color:#ffb300}.card{background:#fff;border-radius:10px;margin:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}.card-header{background:#37474f;color:#fff;padding:12px;font-size:15px;display:flex;justify-content:space-between}.card-body{padding:14px}.form-group{margin-bottom:14px}.form-label{font-size:13px;color:#666;margin-bottom:6px;display:block}.form-input,.form-select{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px}textarea.form-input{min-height:60px}.btn{padding:12px 18px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}.btn-orange{background:#ff9800;color:#fff}.btn-green{background:#4caf50;color:#fff}.btn-blue{background:#2196f3;color:#fff}.btn-red{background:#f44336;color:#fff}.btn-purple{background:#9c27b0;color:#fff}.btn-block{width:100%}.btn-sm{padding:8px 12px;font-size:13px}.filter-btn{padding:8px 12px;border-radius:20px;border:none;font-size:12px;font-weight:600;margin:3px;cursor:pointer}.filter-btn.active{background:#00695c;color:#fff}.filter-btn:not(.active){background:#fff;color:#00695c}.list-item{background:#fff;border-radius:10px;padding:14px;margin:10px 12px;border-left:4px solid #9c27b0}.villa-name{font-weight:700;font-size:16px}.unit-badge{background:#1565c0;color:#fff;padding:4px 10px;border-radius:6px;font-size:13px;margin-left:8px}.status-badge{padding:4px 10px;border-radius:12px;font-size:12px}.action-btns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}.action-btn{padding:8px 12px;border-radius:6px;border:none;font-size:12px;cursor:pointer}.back-header{background:#00695c;color:#fff;padding:14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}.back-btn{background:0 0;border:none;color:#fff;font-size:24px;cursor:pointer}.villa-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}.villa-btn{padding:10px 14px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer;background:#fff;color:#00695c}.villa-btn.active{background:#00695c;color:#fff}.row-2{display:flex;gap:12px}.row-2>div{flex:1}.empty{text-align:center;padding:40px;color:#999}.paid-badge{background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:4px;font-size:11px}.unpaid-badge{background:#ffebee;color:#c62828;padding:2px 8px;border-radius:4px;font-size:11px}.quick-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:10px}.quick-modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:95vh;overflow-y:auto}
.calc-table{width:100%;border-collapse:collapse;font-size:13px;margin:10px 0}.calc-table th,.calc-table td{border:1px solid #ddd;padding:6px 4px;text-align:center}.calc-table th{background:#607d8b;color:#fff;font-size:11px}.calc-table input{width:100%;padding:5px;border:1px solid #ddd;border-radius:4px;text-align:right;font-size:13px}.calc-table .amt{background:#e3f2fd;font-weight:600}.calc-table .del-btn{background:#f44336;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer}
.invoice{background:#fff;border:2px solid #333;padding:15px;font-family:'Malgun Gothic',sans-serif;max-width:400px;margin:0 auto;font-size:13px}
.invoice-header{border-bottom:2px solid #333;padding-bottom:10px;margin-bottom:10px}
.invoice-title{font-size:14px;display:flex;justify-content:space-between}
.invoice-to{font-size:16px;font-weight:700;margin-top:5px}
.invoice-info{font-size:12px;line-height:1.6;border:1px solid #333;padding:8px;margin-bottom:10px}
.invoice-info td{padding:2px 5px}
.invoice-amount{text-align:center;font-size:14px;margin:10px 0;padding:8px;border:1px solid #333}
.invoice-table{width:100%;border-collapse:collapse}.invoice-table th,.invoice-table td{border:1px solid #333;padding:6px;font-size:12px}.invoice-table th{background:#f5f5f5}
.invoice-total{background:#fff3e0;font-weight:700}
.invoice-footer{margin-top:10px;font-size:11px;text-align:center;border:1px solid #333;padding:8px}
.invoice-account{background:#e8f5e9;padding:8px;font-size:12px;text-align:center;margin-top:8px;font-weight:600}
.invoice-contact{display:flex;justify-content:space-around;font-size:11px;margin-top:8px;padding:5px;border:1px solid #333}
.add-row-btn{background:#4caf50;color:#fff;border:none;border-radius:4px;padding:6px 12px;font-size:12px;cursor:pointer;margin-top:8px}
</style>
</head>
<body>
<div id="app"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh"><div style="font-size:48px">ğŸ </div><div style="color:#00695c;margin-top:16px">ì—°ê²° ì¤‘...</div></div></div>

<div id="settleModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeSettleModal()">
<div class="quick-modal-content">
<div style="font-size:18px;font-weight:700;margin-bottom:16px">ğŸ  ì´ì‚¬ì •ì‚° ë“±ë¡</div>
<div class="form-group"><label class="form-label">ë¹Œë¼ *</label><div id="settleVillas" class="villa-grid"></div><input class="form-input" id="sVilla" placeholder="ë¹Œë¼ëª…"></div>
<div class="row-2"><div class="form-group"><label class="form-label">í˜¸ìˆ˜ *</label><input class="form-input" id="sUnit" placeholder="101"></div><div class="form-group"><label class="form-label">í‡´ì‹¤ì¼ *</label><input type="date" class="form-input" id="sDate"></div></div>
<div class="form-group"><label class="form-label">ì£¼ì†Œ</label><input class="form-input" id="sAddr"></div>
<div class="row-2"><div class="form-group"><label class="form-label">ì„¸ì…ì</label><input class="form-input" id="sTenant"></div><div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="sPhone"></div></div>
<div class="form-group"><label class="form-label">ë©”ëª¨</label><textarea class="form-input" id="sMemo" style="min-height:50px"></textarea></div>
<button onclick="saveSettle()" class="btn btn-purple btn-block">ë“±ë¡</button>
<div style="margin-top:12px;text-align:center"><button onclick="closeSettleModal()" style="background:0 0;border:none;color:#999">ë‹«ê¸°</button></div>
</div>
</div>

<div id="detailModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeDetail()">
<div class="quick-modal-content" style="max-width:520px">
<div style="font-size:18px;font-weight:700;margin-bottom:12px">ğŸ“‹ ì •ì‚°ë‚´ì—­</div>
<div id="detailInfo" style="background:#f3e5f5;padding:10px;border-radius:8px;margin-bottom:12px;font-size:14px"></div>
<table class="calc-table">
<thead><tr><th style="width:60px">êµ¬ë¶„</th><th style="width:55px">ì „ì›”</th><th style="width:55px">ì´ì‚¬</th><th style="width:55px">ë‹¨ê°€</th><th style="width:70px">ê¸ˆì•¡</th><th style="width:36px">ì‚­ì œ</th></tr></thead>
<tbody id="calcBody"></tbody>
<tfoot><tr><th colspan="4">í•©ê³„</th><th class="amt" id="totalAmt">0</th><th></th></tr></tfoot>
</table>
<button onclick="addRow()" class="add-row-btn">+ í•­ëª©ì¶”ê°€</button>
<div class="form-group" style="margin-top:12px"><label class="form-label">ì…ê¸ˆê³„ì¢Œ</label><input class="form-input" id="dAccount" value="ë†í˜‘ 356-1253-1342-73 ì´ìš©í›ˆ"></div>
<div class="form-group"><label class="form-label">ë©”ëª¨</label><textarea class="form-input" id="dMemo" style="min-height:50px"></textarea></div>
<div style="display:flex;gap:10px">
<button onclick="saveDetail()" class="btn btn-purple" style="flex:1">ì €ì¥</button>
<button onclick="showInvoice()" class="btn btn-blue" style="flex:1">ì²­êµ¬ì„œ</button>
</div>
<div style="margin-top:12px;text-align:center"><button onclick="closeDetail()" style="background:0 0;border:none;color:#999">ë‹«ê¸°</button></div>
</div>
</div>

<div id="invoiceModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeInvoice()">
<div class="quick-modal-content" style="max-width:420px;padding:10px;background:#f5f5f5">
<div id="invoiceContent"></div>
<div style="margin-top:10px;text-align:center;font-size:12px;color:#666">â†‘ ìº¡ì³í•´ì„œ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚´ì„¸ìš”</div>
<div style="margin-top:8px;text-align:center"><button onclick="closeInvoice()" class="btn btn-sm" style="background:#9e9e9e;color:#fff">ë‹«ê¸°</button></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyBrMcbN2Iv3hjBW0uQx7_gSXAWcwTTSgGI",authDomain:"villa-management-4af75.firebaseapp.com",projectId:"villa-management-4af75",storageBucket:"villa-management-4af75.firebasestorage.app",messagingSenderId:"994416353525",appId:"1:994416353525:web:3bd200acc5d68f6df065bc"});
const db=firebase.firestore();
let villas=[],settlements=[],curSettle=null,calcRows=[];
const today=new Date(Date.now()+9*60*60*1000).toISOString().split('T')[0];

db.collection('villas').onSnapshot(s=>{villas=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'));render()});
db.collection('settlements').onSnapshot(s=>{settlements=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.moveOutDate||'').localeCompare(a.moveOutDate||''));render()});

function openMap(a){if(a)window.open('https://map.naver.com/v5/search/'+encodeURIComponent(a),'_blank')}

// ì´ì‚¬ì •ì‚° ë“±ë¡
function openSettleModal(){
  document.getElementById('settleVillas').innerHTML=villas.map(v=>'<button class="villa-btn" onclick="pickVilla(\''+v.name+'\',\''+( v.address||'')+'\')">'+v.name+'</button>').join('');
  document.getElementById('sVilla').value='';
  document.getElementById('sUnit').value='';
  document.getElementById('sDate').value=today;
  document.getElementById('sAddr').value='';
  document.getElementById('sTenant').value='';
  document.getElementById('sPhone').value='';
  document.getElementById('sMemo').value='';
  document.getElementById('settleModal').style.display='flex';
}
function closeSettleModal(){document.getElementById('settleModal').style.display='none'}
function pickVilla(n,a){document.getElementById('sVilla').value=n;document.getElementById('sAddr').value=a}
async function saveSettle(){
  const villa=document.getElementById('sVilla').value.trim(),unit=document.getElementById('sUnit').value.trim(),date=document.getElementById('sDate').value;
  if(!villa||!unit||!date)return alert('ë¹Œë¼, í˜¸ìˆ˜, í‡´ì‹¤ì¼ í•„ìˆ˜');
  await db.collection('settlements').doc('st_'+Date.now()).set({
    villaName:villa,unit,moveOutDate:date,
    address:document.getElementById('sAddr').value.trim(),
    tenant:document.getElementById('sTenant').value.trim(),
    phone:document.getElementById('sPhone').value.trim(),
    memo:document.getElementById('sMemo').value.trim(),
    items:[
      {name:'ì „ê¸°',prev:'',cur:'',rate:'',amt:''},
      {name:'ìˆ˜ë„',prev:'',cur:'',rate:'',amt:'',auto:true},
< truncated lines 108-218 >
    <div class="invoice-title"><span>â–¡ ì˜ìˆ˜ì¦ â–  ì²­êµ¬ì„œ</span><span style="font-size:12px">(ê³µê¸‰ë°›ëŠ”ììš©)</span></div>
    <div class="invoice-to">${curSettle.villaName} ${curSettle.unit}í˜¸ ê·€í•˜</div>
  </div>
  
  <table class="invoice-info" style="width:100%;border-collapse:collapse">
    <tr><td style="width:30%">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</td><td><b>305-19-82608</b></td></tr>
    <tr><td>ìƒí˜¸</td><td><b>í•˜ìš°ìŠ¤ì£¼íƒê´€ë¦¬</b> &nbsp; ì„±ëª…: ì´ìš©í›ˆ (ì¸)</td></tr>
    <tr><td>ì‚¬ì—…ì¥ì†Œì¬ì§€</td><td>ëŒ€ì „ê´‘ì—­ì‹œ ì¤‘êµ¬ ì„ í™”ì„œë¡œ19ë²ˆê¸¸ 48</td></tr>
    <tr><td>ì—…íƒœ</td><td>ì„œë¹„ìŠ¤ &nbsp; ì¢…ëª©: ê´€ë¦¬ìš©ì—­</td></tr>
  </table>

  <div class="invoice-amount">
    <div>ì‘ì„±ë…„ì›”ì¼: <b>${today}</b></div>
    <div style="font-size:16px;margin-top:5px">ê³µê¸‰ëŒ€ê°€ì´ì•¡: <b>ï¿¦ ${total.toLocaleString()}</b></div>
    <div style="font-size:11px;margin-top:3px">ìœ„ ê¸ˆì•¡ì„ ì •íˆ ì˜ìˆ˜(ì²­êµ¬)í•¨.</div>
  </div>

  <table class="invoice-table">
    <thead><tr><th style="width:30px">NO</th><th>í’ˆëª©</th><th style="width:80px">ê³µê¸‰ëŒ€ê°€(ê¸ˆì•¡)</th></tr></thead>
    <tbody>${itemsHtml}</tbody>
    <tfoot><tr class="invoice-total"><td colspan="2" style="text-align:center">í•© ê³„</td><td style="text-align:right">ï¿¦ ${total.toLocaleString()}</td></tr></tfoot>
  </table>

  <div class="invoice-account">
    ì •ì‚°ê¸ˆì€ ì•„ë˜ ê³„ì¢Œë²ˆí˜¸ë¡œ ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.<br>
    <span style="font-size:14px">${account}</span>
  </div>

  <div class="invoice-contact">
    <span>í•œì „: 042-123</span>
    <span>ë„ì‹œê°€ìŠ¤: 1666-0009</span>
    <span>ê´€ë¦¬ì‚¬ë¬´ì†Œ: 042-673-5575</span>
  </div>

  <div class="invoice-footer">
    â€» ê³µê³¼ê¸ˆ ì…ê¸ˆì™„ë£Œ í›„ ë³´ì¦ê¸ˆ í™˜ë¶ˆ ê°€ëŠ¥ â€»
  </div>
</div>`;
  
  document.getElementById('invoiceContent').innerHTML=html;
  document.getElementById('invoiceModal').style.display='flex';
}
function closeInvoice(){document.getElementById('invoiceModal').style.display='none'}

async function markPaid(id){if(confirm('ì…ê¸ˆì™„ë£Œ ì²˜ë¦¬?'))await db.collection('settlements').doc(id).update({isPaid:true})}
async function delSettle(id){if(confirm('ì‚­ì œ?'))await db.collection('settlements').doc(id).delete()}
function render(){
  const app=document.getElementById('app');
  const unpaid=settlements.filter(s=>!s.isPaid);
  const unpaidTotal=unpaid.reduce((s,t)=>s+(t.total||0),0);

  let list=settlements.map(s=>`
<div class="list-item">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <span class="villa-name">${s.villaName}</span>
      <span class="unit-badge">${s.unit}í˜¸</span>
      <span class="${s.isPaid?'paid-badge':'unpaid-badge'}">${s.isPaid?'ì…ê¸ˆì™„ë£Œ':'ë¯¸ì…ê¸ˆ'}</span>
    </div>
    <div style="font-weight:700;color:#7b1fa2;font-size:15px">${(s.total||0).toLocaleString()}ì›</div>
  </div>
  ${s.address?`<div style="font-size:12px;color:#1565c0;margin-top:6px;cursor:pointer" onclick="openMap('${s.address}')">ğŸ“ ${s.address}</div>`:''}
  <div style="font-size:13px;color:#666;margin-top:6px">
    í‡´ì‹¤: ${s.moveOutDate}${s.tenant?' | ì„¸ì…ì: '+s.tenant:''}${s.phone?' | '+s.phone:''}
  </div>
  ${s.memo?`<div style="font-size:12px;color:#888;margin-top:4px;background:#f5f5f5;padding:6px;border-radius:4px">ğŸ“ ${s.memo}</div>`:''}
  <div class="action-btns">
    <button class="action-btn btn-purple" onclick="openDetail('${s.id}')">ğŸ“‹ ì •ì‚°ë‚´ì—­</button>
    ${!s.isPaid?`<button class="action-btn btn-green" onclick="markPaid('${s.id}')">ğŸ’° ì…ê¸ˆì™„ë£Œ</button>`:''}
    <button class="action-btn btn-red" onclick="delSettle('${s.id}')">ì‚­ì œ</button>
  </div>
</div>`).join('');

  app.innerHTML=`
<div class="header">
  <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
    <div>
      <h1 style="font-size:20px;margin:0">ğŸ  ì´ì‚¬ì •ì‚°</h1>
      <div style="font-size:11px;opacity:.9;margin-top:2px">ë¹Œë¼ ${villas.length}ê°œ | ì •ì‚° ${settlements.length}ê±´</div>
    </div>
    <button onclick="openSettleModal()" style="background:#fff;color:#7b1fa2;border:none;padding:10px 16px;border-radius:8px;font-weight:700;font-size:14px">+ ë“±ë¡</button>
  </div>
</div>

<div style="padding:12px">
  ${unpaidTotal>0?`
  <div style="background:#f3e5f5;padding:14px;border-radius:10px;margin-bottom:12px">
    <div style="color:#7b1fa2;font-weight:700;font-size:15px">ğŸ’¸ ë¯¸ì…ê¸ˆ í•©ê³„</div>
    <div style="font-size:24px;font-weight:700;color:#7b1fa2;margin-top:4px">${unpaidTotal.toLocaleString()}ì›</div>
    <div style="font-size:12px;color:#666;margin-top:2px">${unpaid.length}ê±´</div>
  </div>`:''}
  
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <span class="filter-btn active">ì „ì²´ (${settlements.length})</span>
    <span class="filter-btn">ë¯¸ì…ê¸ˆ (${unpaid.length})</span>
    <span class="filter-btn">ì™„ë£Œ (${settlements.length-unpaid.length})</span>
  </div>
</div>

${settlements.length?list:'<div class="empty">ì´ì‚¬ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤<br><br>ìš°ì¸¡ ìƒë‹¨ [+ ë“±ë¡] ë²„íŠ¼ìœ¼ë¡œ<br>ìƒˆ ì´ì‚¬ì •ì‚°ì„ ë“±ë¡í•˜ì„¸ìš”</div>'}
`;
}

setTimeout(render,1000);
</script>
</body>
</html>
