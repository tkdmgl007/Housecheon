<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¹Œë¼ ê´€ë¦¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%);
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(90deg, #00695c, #00897b);
      color: white;
      padding: 14px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header-sub { font-size: 11px; opacity: 0.9; margin-top: 2px; }
    
    .tabs { display: flex; background: #004d40; }
    .tab {
      flex: 1; padding: 14px 8px; text-align: center; color: white; border: none;
      background: transparent; font-size: 14px; font-weight: 500; cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active { background: #00796b; border-bottom-color: #ffb300; }
    
    .card {
      background: white; border-radius: 10px; margin: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;
    }
    .card-header {
      background: #37474f; color: white; padding: 12px 14px;
      font-size: 15px; font-weight: 600;
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-body { padding: 14px; }
    
    .form-group { margin-bottom: 14px; }
    .form-label { font-size: 13px; color: #666; margin-bottom: 6px; display: block; font-weight: 500; }
    .form-input {
      width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 16px; outline: none;
    }
    .form-input:focus { border-color: #00897b; }
    textarea.form-input { min-height: 80px; resize: vertical; }
    
    .btn {
      padding: 12px 18px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer;
    }
    .btn-orange { background: #ff9800; color: white; }
    .btn-green { background: #4caf50; color: white; }
    .btn-blue { background: #2196f3; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-block { width: 100%; }
    .btn-sm { padding: 8px 12px; font-size: 13px; }
    
    .filter-btn {
      padding: 8px 14px; border-radius: 20px; border: none;
      font-size: 13px; font-weight: 600; margin-right: 6px; margin-bottom: 6px; cursor: pointer;
    }
    .filter-btn.active { background: #00695c; color: white; }
    .filter-btn:not(.active) { background: white; color: #00695c; }
    
    .list-item {
      background: white; border-radius: 10px; padding: 14px;
      margin: 10px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #ff9800;
    }
    .list-item.done { border-left-color: #4caf50; }
    .villa-name { font-weight: 700; font-size: 16px; }
    .unit-badge {
      background: #1565c0; color: white; padding: 4px 10px;
      border-radius: 6px; font-size: 13px; font-weight: 600; margin-left: 8px;
    }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-badge.pending { background: #fff3e0; color: #e65100; }
    .status-badge.done { background: #e8f5e9; color: #2e7d32; }
    .time-badge { background: #e3f2fd; color: #1565c0; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px; }
    .list-item-desc { color: #333; font-size: 14px; line-height: 1.5; margin: 8px 0; }
    .list-item-date { font-size: 11px; color: #999; }
    .list-item-address { font-size: 12px; color: #1565c0; margin-top: 4px; cursor: pointer; text-decoration: underline; }
    
    .phone-btn {
      display: inline-block; padding: 6px 12px; border-radius: 6px;
      font-size: 12px; text-decoration: none; margin-right: 6px; margin-top: 6px;
    }
    .phone-btn.owner { background: #fff3e0; color: #e65100; }
    .phone-btn.tenant { background: #e8f5e9; color: #2e7d32; }
    
    .action-btns { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .action-btn {
      padding: 8px 14px; border-radius: 6px; border: none;
      font-size: 13px; font-weight: 500; cursor: pointer;
    }
    
    .search-box {
      background: white; margin: 12px; border-radius: 10px; padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .search-input {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 15px; outline: none;
    }
    .search-input:focus { border-color: #00897b; }
    
    .search-history { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .search-history-title { font-size: 12px; color: #999; margin-bottom: 8px; }
    .search-history-item {
      display: inline-block; background: #f5f5f5; padding: 6px 12px;
      border-radius: 16px; font-size: 13px; margin: 3px; cursor: pointer;
    }
    
    .date-filter {
      display: flex; gap: 8px; padding: 12px; overflow-x: auto; flex-wrap: wrap;
    }
    .date-btn {
      padding: 8px 14px; border-radius: 20px; border: none;
      font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap;
    }
    .date-btn.active { background: #00695c; color: white; }
    .date-btn:not(.active) { background: white; color: #333; }
    
    .back-header {
      background: #00695c; color: white; padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
      position: sticky; top: 0; z-index: 100;
    }
    .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
    .back-title { font-size: 18px; font-weight: 600; }
    
    .villa-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .villa-btn {
      padding: 10px 14px; border-radius: 8px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer;
      background: white; color: #00695c; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .villa-btn.active { background: #00695c; color: white; }
    
    .row-2 { display: flex; gap: 12px; }
    .row-2 > div { flex: 1; }
    .row-3 { display: flex; gap: 12px; }
    .row-3 > div { flex: 1; }
    
    .status-select { display: flex; gap: 10px; }
    .status-option {
      flex: 1; padding: 14px; border-radius: 8px; border: none;
      font-size: 16px; font-weight: 600; cursor: pointer; text-align: center;
    }
    .status-option.pending { background: #eee; color: #666; }
    .status-option.pending.active { background: #ff9800; color: white; }
    .status-option.done { background: #eee; color: #666; }
    .status-option.done.active { background: #4caf50; color: white; }
    
    .time-select { display: flex; gap: 8px; flex-wrap: wrap; }
    .time-option {
      padding: 10px 16px; border-radius: 8px; border: 2px solid #ddd;
      font-size: 14px; font-weight: 600; cursor: pointer; background: white;
    }
    .time-option.active { border-color: #00695c; background: #e0f2f1; color: #00695c; }
    
    .loading {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 100vh;
    }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
    .loading-text { color: #00695c; font-size: 16px; }
    
    .empty { text-align: center; padding: 40px 20px; color: #999; }
    
    .supplier-badge {
      display: inline-block; background: #e3f2fd; color: #1565c0;
      padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px;
    }
    
    .unit-table { width: 100%; border-collapse: collapse; }
    .unit-table th {
      background: #607d8b; color: white; padding: 10px 8px;
      text-align: left; font-size: 13px;
    }
    .unit-table td { padding: 12px 8px; border-bottom: 1px solid #eee; }
    .unit-num {
      display: inline-block; background: #e3f2fd; color: #1565c0;
      padding: 6px 12px; border-radius: 6px; font-weight: 700;
    }

    .villa-info {
      background: #f5f5f5; padding: 12px; border-radius: 8px;
      margin-bottom: 12px; font-size: 13px;
    }
    
    .material-item { padding: 12px 0; border-bottom: 1px solid #eee; }
    .material-name { font-weight: 600; font-size: 15px; }
    .material-price { font-size: 13px; color: #666; margin-top: 4px; }
    
    .mic-btn {
      background: #f44336; color: white; border: none; 
      width: 50px; height: 50px; border-radius: 50%;
      font-size: 24px; cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .mic-btn.recording { animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .map-btn {
      background: #4caf50; color: white; padding: 12px 20px;
      border: none; border-radius: 8px; font-size: 15px; font-weight: 600;
      margin: 12px; display: block; width: calc(100% - 24px);
      cursor: pointer;
    }
    
    .quick-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 200;
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .quick-modal-content {
      background: white; border-radius: 16px; padding: 20px;
      width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto;
    }
    .quick-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
    .quick-textarea {
      width: 100%; min-height: 100px; padding: 14px; border: 2px solid #ddd;
      border-radius: 10px; font-size: 16px; resize: none; outline: none;
    }
    .quick-textarea:focus { border-color: #00695c; }
  </style>
</head>
<body>

<div id="app">
  <div class="loading">
    <div class="loading-icon">ğŸ </div>
    <div class="loading-text">ì—°ê²° ì¤‘...</div>
  </div>
</div>

<div id="quickModal" style="display:none;" class="quick-modal" onclick="if(event.target===this)closeQuickModal()">
  <div class="quick-modal-content">
    <div class="quick-modal-title">âš¡ ë¹ ë¥¸ ì ‘ìˆ˜</div>
    <textarea id="quickInput" class="quick-textarea" placeholder="ì˜ˆ: ì¸í•˜ìš°ìŠ¤ 102 ì˜¤ì „ 11ì‹œ ê²¸ìš©ìˆ˜ì „ êµì²´&#10;&#10;í˜•ì‹: [ë¹Œë¼] [í˜¸ìˆ˜] [ì‹œê°„] [ë‚´ìš©]"></textarea>
    <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
      <button onclick="startVoice()" class="mic-btn" id="micBtn">ğŸ¤</button>
      <div style="flex:1;">
        <button onclick="submitQuick()" class="btn btn-orange btn-block">ì ‘ìˆ˜í•˜ê¸°</button>
      </div>
    </div>
    <div style="margin-top:12px;">
      <div style="font-size:12px;color:#666;margin-bottom:8px;">â° ì‹œê°„ ì„ íƒ</div>
      <div class="time-select">
        <button type="button" class="time-option" onclick="addTimeToQuick('ì˜¤ì „')">ì˜¤ì „</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('ì˜¤í›„')">ì˜¤í›„</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('ë¯¸ì •')">ë¯¸ì •</button>
      </div>
      <div class="time-select" style="margin-top:8px;">
        <button type="button" class="time-option" onclick="addTimeToQuick('9ì‹œ')">9ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('10ì‹œ')">10ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('11ì‹œ')">11ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('12ì‹œ')">12ì‹œ</button>
      </div>
      <div class="time-select" style="margin-top:8px;">
        <button type="button" class="time-option" onclick="addTimeToQuick('1ì‹œ')">1ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('2ì‹œ')">2ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('3ì‹œ')">3ì‹œ</button>
        <button type="button" class="time-option" onclick="addTimeToQuick('4ì‹œ')">4ì‹œ</button>
      </div>
    </div>
    <div style="margin-top:16px;text-align:center;">
      <button onclick="closeQuickModal()" style="background:none;border:none;color:#999;font-size:14px;cursor:pointer;">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBrMcbN2Iv3hjBW0uQx7_gSXAWcwTTSgGI",
  authDomain: "villa-management-4af75.firebaseapp.com",
  projectId: "villa-management-4af75",
  storageBucket: "villa-management-4af75.firebasestorage.app",
  messagingSenderId: "994416353525",
  appId: "1:994416353525:web:3bd200acc5d68f6df065bc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentPage = 'list';
let currentTab = 'as';
let filter = 'ë¯¸ê²°';
let selectedDate = 'all';
let villas = [];
let units = [];
let repairs = [];
let materials = [];
let editData = null;
let selectedVilla = null;
let searchText = '';
let supplierFilter = 'all';
let globalSearchMode = false;

let asSearchHistory = JSON.parse(localStorage.getItem('asSearchHistory') || '[]');
let villaSearchHistory = JSON.parse(localStorage.getItem('villaSearchHistory') || '[]');
let materialSearchHistory = JSON.parse(localStorage.getItem('materialSearchHistory') || '[]');

// í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ
function getKoreanToday() {
  const now = new Date();
  const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
  return koreaTime.toISOString().split('T')[0];
}
const today = getKoreanToday();

// ë¹ ë¥¸ì ‘ìˆ˜ ì„ì‹œì €ì¥ ë³µì›
window.addEventListener('load', () => {
  const saved = localStorage.getItem('quickDraft');
  if (saved) {
    setTimeout(() => {
      if (confirm('ì‘ì„± ì¤‘ì´ë˜ ë¹ ë¥¸ì ‘ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì‘ì„±í• ê¹Œìš”?')) {
        document.getElementById('quickInput').value = saved;
        openQuickModal();
      } else {
        localStorage.removeItem('quickDraft');
      }
    }, 1500);
  }
});

// ë¹ ë¥¸ì ‘ìˆ˜ ì…ë ¥ì‹œ ìë™ì €ì¥
function saveQuickDraft() {
  const val = document.getElementById('quickInput')?.value || '';
  if (val.trim()) {
    localStorage.setItem('quickDraft', val);
  } else {
    localStorage.removeItem('quickDraft');
  }
}

db.collection('villas').onSnapshot(snap => {
  villas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  villas.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));
  render();
});
db.collection('units').onSnapshot(snap => {
  units = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('repairs').onSnapshot(snap => {
  repairs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('materials').onSnapshot(snap => {
  materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  materials.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));
  render();
});

function addSearchHistory(text, type) {
  if (!text || text.length < 1) return;
  let history, key;
  if (type === 'as') { history = asSearchHistory; key = 'asSearchHistory'; }
  else if (type === 'villa') { history = villaSearchHistory; key = 'villaSearchHistory'; }
  else { history = materialSearchHistory; key = 'materialSearchHistory'; }
  
  history = history.filter(h => h !== text);
  history.unshift(text);
  history = history.slice(0, 10);
  
  if (type === 'as') asSearchHistory = history;
  else if (type === 'villa') villaSearchHistory = history;
  else materialSearchHistory = history;
  
  localStorage.setItem(key, JSON.stringify(history));
}

function getUniqueDates() {
  const dates = [...new Set(repairs.map(r => r.receiveDate).filter(Boolean))];
  return dates.sort().reverse();
}

function getUniqueSuppliers() {
  return [...new Set(materials.map(m => m.supplier).filter(Boolean))].sort((a,b) => a.localeCompare(b, 'ko'));
}

function openNaverMap(address) {
  if (!address) return;
  const encoded = encodeURIComponent(address);
  window.open(`https://map.naver.com/v5/search/${encoded}`, '_blank');
}

// ì˜¤ëŠ˜ ì¼ì • ì§€ë„ì— í‘œì‹œ
function openTodayMap() {
  const todayRepairs = repairs.filter(r => r.receiveDate === today && r.status === 'ë¯¸ê²°' && r.address);
  if (todayRepairs.length === 0) {
    alert('ì˜¤ëŠ˜ ì¼ì • ì¤‘ ì£¼ì†Œê°€ ìˆëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ë„¤ì´ë²„ì§€ë„ ê²½ìœ ì§€ URL ìƒì„±
  const addresses = todayRepairs.map(r => r.address).join(',');
  const encoded = encodeURIComponent(addresses);
  
  // ë„¤ì´ë²„ë§µ ì—´ê¸° (ë‹¤ì¤‘ ê²€ìƒ‰)
  if (todayRepairs.length === 1) {
    window.open(`https://map.naver.com/v5/search/${encodeURIComponent(todayRepairs[0].address)}`, '_blank');
  } else {
    // ì—¬ëŸ¬ ê³³ì´ë©´ ì²«ë²ˆì§¸ ì£¼ì†Œë¡œ ê²€ìƒ‰ (ë„¤ì´ë²„ë§µì€ ê²½ìœ ì§€ URL ì§€ì› ì œí•œì )
    const msg = todayRepairs.map((r, i) => `${i+1}. ${r.villaName} ${r.unit}í˜¸ - ${r.address}`).join('\n');
    alert('ğŸ“ ì˜¤ëŠ˜ ì¼ì • (' + todayRepairs.length + 'ê³³)\n\n' + msg + '\n\nì²«ë²ˆì§¸ ì¥ì†Œë¡œ ì§€ë„ë¥¼ ì—½ë‹ˆë‹¤.');
    window.open(`https://map.naver.com/v5/search/${encodeURIComponent(todayRepairs[0].address)}`, '_blank');
  }
}

function render() {
  const app = document.getElementById('app');
  
  if (globalSearchMode) {
    renderGlobalSearch();
    return;
  }
  
  if (currentPage === 'list') {
    if (currentTab === 'as') renderASList(app);
    else if (currentTab === 'villa') renderVillaList(app);
    else if (currentTab === 'material') renderMaterialList(app);
  } else if (currentPage === 'asForm') {
    renderASForm(app);
  } else if (currentPage === 'villaForm') {
    renderVillaForm(app);
  } else if (currentPage === 'unitForm') {
    renderUnitForm(app);
  } else if (currentPage === 'materialForm') {
    renderMaterialForm(app);
  }
}

function renderASList(app) {
  let filtered = repairs.filter(r => filter === 'ì „ì²´' ? true : r.status === filter);
  
  if (selectedDate !== 'all') {
    filtered = filtered.filter(r => r.receiveDate === selectedDate);
  }
  
  if (searchText) {
    const s = searchText.toLowerCase();
    filtered = filtered.filter(r => 
      (r.villaName || '').toLowerCase().includes(s) ||
      (r.unit || '').toLowerCase().includes(s) ||
      (r.description || '').toLowerCase().includes(s) ||
      (r.address || '').toLowerCase().includes(s)
    );
  }
  
  filtered = filtered.sort((a, b) => (b.receiveDate || '').localeCompare(a.receiveDate || ''));
  const dates = getUniqueDates();
  const todayCount = repairs.filter(r => r.receiveDate === today && r.status === 'ë¯¸ê²°').length;
  
  app.innerHTML = `
    <div class="header">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
        <div>
          <h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1>
          <div class="header-sub">ë¹Œë¼ ${villas.length} | ìˆ˜ë¦¬ ${repairs.length} | ìì¬ ${materials.length}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="openQuickModal()" style="background:#ff9800;border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;">âš¡ ë¹ ë¥¸ì ‘ìˆ˜</button>
          <button onclick="openGlobalSearch()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;">ğŸ”</button>
          <button onclick="setApiKey()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;">âš™ï¸</button>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    ${todayCount > 0 ? `<button class="map-btn" onclick="openTodayMap()">ğŸ—ºï¸ ì˜¤ëŠ˜ ì¼ì • ì§€ë„ë³´ê¸° (${todayCount}ê±´)</button>` : ''}
    
    <div class="search-box">
      <input type="text" class="search-input" placeholder="ğŸ” ë¹Œë¼ëª…, í˜¸ìˆ˜, ë‚´ìš© ê²€ìƒ‰..." value="${searchText}" oninput="searchText=this.value" onkeypress="if(event.key==='Enter'){addSearchHistory(searchText,'as');render();}">
      ${asSearchHistory.length > 0 ? `
        <div class="search-history">
          <div class="search-history-title">ìµœê·¼ ê²€ìƒ‰</div>
          ${asSearchHistory.map(h => `<span class="search-history-item" onclick="searchText='${h}';render();">${h}</span>`).join('')}
        </div>
      ` : ''}
    </div>
    
    <div style="padding: 0 12px;">
      <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 8px;">
        <button class="filter-btn ${filter === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setFilter('ë¯¸ê²°')">ë¯¸ê²° (${repairs.filter(r => r.status === 'ë¯¸ê²°').length})</button>
        <button class="filter-btn ${filter === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setFilter('ì™„ë£Œ')">ì™„ë£Œ (${repairs.filter(r => r.status === 'ì™„ë£Œ').length})</button>
        <button class="filter-btn ${filter === 'ì „ì²´' ? 'active' : ''}" onclick="setFilter('ì „ì²´')">ì „ì²´ (${repairs.length})</button>
        <button class="btn btn-orange btn-sm" style="margin-left: auto;" onclick="goASForm()">+ ì ‘ìˆ˜</button>
      </div>
      
      <div class="date-filter">
        <button class="date-btn ${selectedDate === 'all' ? 'active' : ''}" onclick="setDateFilter('all')">ì „ì²´ë‚ ì§œ</button>
        <button class="date-btn ${selectedDate === today ? 'active' : ''}" onclick="setDateFilter('${today}')">ì˜¤ëŠ˜</button>
        ${dates.slice(0, 7).map(d => `
          <button class="date-btn ${selectedDate === d ? 'active' : ''}" onclick="setDateFilter('${d}')">${d.slice(5)}</button>
        `).join('')}
      </div>
    </div>
    
    ${filtered.length === 0 ? '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : filtered.map(r => `
      <div class="list-item ${r.status === 'ì™„ë£Œ' ? 'done' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <span class="villa-name">${r.villaName || ''}</span>
            <span class="unit-badge">${r.unit || ''}</span>
            <span class="status-badge ${r.status === 'ì™„ë£Œ' ? 'done' : 'pending'}">${r.status || 'ë¯¸ê²°'}</span>
            ${r.visitTime ? `<span class="time-badge">â° ${r.visitTime}</span>` : ''}
          </div>
          <div class="list-item-date">${r.receiveDate || ''}</div>
        </div>
        ${r.address ? `<div class="list-item-address" onclick="openNaverMap('${r.address}')">ğŸ“ ${r.address} (ì§€ë„ë³´ê¸°)</div>` : ''}
        <div class="list-item-desc">${r.description || ''}</div>
        <div>
          ${r.ownerPhone ? `<a href="tel:${r.ownerPhone}" class="phone-btn owner">ê±´ë¬¼ì£¼ ğŸ“</a><a href="sms:${r.ownerPhone}" class="phone-btn owner">ë¬¸ì</a>` : ''}
          ${r.phone ? `<a href="tel:${r.phone}" class="phone-btn tenant">ì„¸ì…ì ğŸ“</a><a href="sms:${r.phone}" class="phone-btn tenant">ë¬¸ì</a>` : ''}
        </div>
        <div class="action-btns">
          <button class="action-btn btn-${r.status === 'ì™„ë£Œ' ? 'orange' : 'green'}" onclick="toggleStatus('${r.id}')">${r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°ë¡œ' : 'ì™„ë£Œë¡œ'}</button>
          <button class="action-btn btn-blue" onclick="editRepair('${r.id}')">ìˆ˜ì •</button>
          <button class="action-btn btn-red" onclick="deleteRepair('${r.id}')">ì‚­ì œ</button>
        </div>
      </div>
    `).join('')}
  `;
}

function renderASForm(app) {
  const data = editData || { villaName: '', unit: '', description: '', receiveDate: today, status: 'ë¯¸ê²°', phone: '', ownerPhone: '', address: '', visitTime: '' };
  const villaNames = [...new Set(villas.map(v => v.name))].sort((a,b) => a.localeCompare(b, 'ko'));
  const selectedVillaData = villas.find(v => v.name === data.villaName);
  const villaUnits = selectedVillaData ? units.filter(u => u.villaId === selectedVillaData.id).sort((a,b) => (parseInt(a.unit)||0) - (parseInt(b.unit)||0)) : [];
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData ? 'A/S ìˆ˜ì •' : 'A/S ì ‘ìˆ˜'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ì ‘ìˆ˜ì¼</label>
            <input type="date" class="form-input" id="receiveDate" value="${data.receiveDate}">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë°©ë¬¸ ì‹œê°„</label>
            <div class="time-select" style="margin-bottom:8px;">
              <button type="button" class="time-option ${data.visitTime === 'ì˜¤ì „' ? 'active' : ''}" onclick="setVisitTime('ì˜¤ì „')">ì˜¤ì „</button>
              <button type="button" class="time-option ${data.visitTime === 'ì˜¤í›„' ? 'active' : ''}" onclick="setVisitTime('ì˜¤í›„')">ì˜¤í›„</button>
              <button type="button" class="time-option ${data.visitTime === 'ë¯¸ì •' ? 'active' : ''}" onclick="setVisitTime('ë¯¸ì •')">ë¯¸ì •</button>
            </div>
            <input type="text" class="form-input" id="visitTime" value="${data.visitTime || ''}" placeholder="ì˜ˆ: ì˜¤ì „ 11ì‹œ, ì˜¤í›„ 2ì‹œ~3ì‹œ">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ *</label>
            ${villaNames.length > 0 ? `
              <div class="villa-grid">
                ${villaNames.map(v => `<button type="button" class="villa-btn ${data.villaName === v ? 'active' : ''}" onclick="selectVillaAS('${v}')">${v}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="villaName" value="${data.villaName}" placeholder="ë¹Œë¼ëª… ì…ë ¥ (ì‹ ê·œì‹œ ìë™ ë“±ë¡)">
          </div>
          
          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="address" value="${data.address || selectedVillaData?.address || ''}" placeholder="ì£¼ì†Œ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            ${villaUnits.length > 0 ? `
              <div class="villa-grid">
                ${villaUnits.map(u => `<button type="button" class="villa-btn ${data.unit === u.unit ? 'active' : ''}" style="background:${data.unit === u.unit ? '#2e7d32' : 'white'}; color:${data.unit === u.unit ? 'white' : '#2e7d32'}" onclick="selectUnitAS('${u.unit}', '${u.phone || ''}')">${u.unit}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="unit" value="${data.unit}" placeholder="í˜¸ìˆ˜ ì…ë ¥ (ì‹ ê·œì‹œ ìë™ ë“±ë¡)">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <textarea class="form-input" id="description" placeholder="ìˆ˜ë¦¬ ë‚´ìš©">${data.description}</textarea>
          </div>
          
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">ì„¸ì…ì ì „í™”</label>
              <input type="tel" class="form-input" id="phone" value="${data.phone}" placeholder="010-0000-0000">
            </div>
            <div class="form-group">
              <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
              <input type="tel" class="form-input" id="ownerPhone" value="${data.ownerPhone || selectedVillaData?.ownerPhone || ''}" placeholder="010-0000-0000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒíƒœ</label>
            <div class="status-select">
              <button type="button" class="status-option pending ${data.status === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setStatusForm('ë¯¸ê²°')">ë¯¸ê²°</button>
              <button type="button" class="status-option done ${data.status === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setStatusForm('ì™„ë£Œ')">ì™„ë£Œ</button>
            </div>
          </div>
          
          <button type="button" class="btn btn-orange btn-block" onclick="saveRepair()" style="margin-top: 10px;">
            ${editData ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì ‘ìˆ˜í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  `;
}

function renderVillaList(app) {
  let filteredVillas = villas;
  if (searchText) {
    const s = searchText.toLowerCase();
    filteredVillas = villas.filter(v => 
      (v.name || '').toLowerCase().includes(s) ||
      (v.address || '').toLowerCase().includes(s) ||
      (v.ownerPhone || '').includes(s)
    );
  }
  const villaUnits = selectedVilla ? units.filter(u => u.villaId === selectedVilla.id).sort((a,b) => (parseInt(a.unit)||0) - (parseInt(b.unit)||0)) : [];
  
  app.innerHTML = `
    <div class="header">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
        <div><h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1></div>
        <div style="display:flex;gap:8px;">
          <button onclick="openQuickModal()" style="background:#ff9800;border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;">âš¡</button>
          <button onclick="openGlobalSearch()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;">ğŸ”</button>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab active" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" placeholder="ğŸ” ë¹Œë¼ëª…, ì£¼ì†Œ, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰..." value="${searchText}" oninput="searchText=this.value" onkeypress="if(event.key==='Enter'){addSearchHistory(searchText,'villa');render();}">
      ${villaSearchHistory.length > 0 ? `
        <div class="search-history">
          <div class="search-history-title">ìµœê·¼ ê²€ìƒ‰</div>
          ${villaSearchHistory.map(h => `<span class="search-history-item" onclick="searchText='${h}';render();">${h}</span>`).join('')}
        </div>
      ` : ''}
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-weight: 600; color: #00695c;">ë¹Œë¼ ëª©ë¡ (${filteredVillas.length})</span>
        <button class="btn btn-orange btn-sm" onclick="goVillaForm()">+ ë¹Œë¼ì¶”ê°€</button>
      </div>
      
      <div class="villa-grid">
        ${filteredVillas.map(v => `<button class="villa-btn ${selectedVilla?.id === v.id ? 'active' : ''}" onclick="selectVillaView('${v.id}')">${v.name}</button>`).join('')}
      </div>
    </div>
    
    ${selectedVilla ? `
      <div class="card">
        <div class="card-header">
          <span>${selectedVilla.name}</span>
          <div>
            <button class="btn btn-blue btn-sm" onclick="editVilla('${selectedVilla.id}')" style="margin-right:4px;">ìˆ˜ì •</button>
            <button class="btn btn-green btn-sm" onclick="goUnitForm('${selectedVilla.id}')" style="margin-right:4px;">+í˜¸ìˆ˜</button>
            <button class="btn btn-red btn-sm" onclick="deleteVilla('${selectedVilla.id}')">ì‚­ì œ</button>
          </div>
        </div>
        <div class="villa-info">
          ${selectedVilla.address ? `<div class="list-item-address" onclick="openNaverMap('${selectedVilla.address}')" style="margin-bottom:4px;">ğŸ“ ${selectedVilla.address} (ì§€ë„)</div>` : '<div>ğŸ“ ì£¼ì†Œ ì—†ìŒ</div>'}
          <div>ğŸ‘¤ ê±´ë¬¼ì£¼ ${selectedVilla.ownerPhone ? `<a href="tel:${selectedVilla.ownerPhone}" style="color:#1565c0;">${selectedVilla.ownerPhone}</a>` : '-'}</div>
        </div>
        <div class="card-body" style="padding-top:0;">
          <table class="unit-table">
            <thead><tr><th style="width:70px;">í˜¸ìˆ˜</th><th>ì„¸ì…ì / ì—°ë½ì²˜</th><th style="width:80px;">ê´€ë¦¬</th></tr></thead>
            <tbody>
              ${villaUnits.length === 0 ? '<tr><td colspan="3" style="text-align:center;color:#999;padding:20px;">ë“±ë¡ëœ í˜¸ìˆ˜ ì—†ìŒ</td></tr>' : villaUnits.map(u => `
                <tr>
                  <td><span class="unit-num">${u.unit}</span></td>
                  <td>
                    <div style="font-weight:600;">${u.tenant || '(ê³µì‹¤)'}</div>
                    ${u.phone ? `<a href="tel:${u.phone}" style="color:#1565c0;font-size:13px;">${u.phone}</a>` : ''}
                    ${u.moveIn ? `<div style="font-size:11px;color:#888;">ì…ì£¼: ${u.moveIn}</div>` : ''}
                  </td>
                  <td>
                    <button class="btn btn-blue btn-sm" onclick="editUnit('${u.id}')" style="margin-bottom:4px;display:block;width:100%;">ìˆ˜ì •</button>
                    <button class="btn btn-red btn-sm" onclick="deleteUnit('${u.id}')" style="display:block;width:100%;">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    ` : ''}
  `;
}

function renderVillaForm(app) {
  const data = editData || { name: '', address: '', ownerPhone: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'ë¹Œë¼ ìˆ˜ì •' : 'ë¹Œë¼ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ëª… *</label>
            <input type="text" class="form-input" id="villaNameInput" value="${data.name}" placeholder="ë¹Œë¼ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="villaAddress" value="${data.address || ''}" placeholder="ì£¼ì†Œ">
          </div>
          <div class="form-group">
            <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
            <input type="tel" class="form-input" id="villaOwnerPhone" value="${data.ownerPhone || ''}" placeholder="010-0000-0000">
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveVilla()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

function renderUnitForm(app) {
  const data = editData || { unit: '', tenant: '', phone: '', moveIn: '', memo: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'í˜¸ìˆ˜ ìˆ˜ì •' : 'í˜¸ìˆ˜ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            <input type="text" class="form-input" id="unitNum" value="${data.unit}" placeholder="101">
          </div>
          <div class="form-group">
            <label class="form-label">ì„¸ì…ì</label>
            <input type="text" class="form-input" id="unitTenant" value="${data.tenant || ''}" placeholder="ì„¸ì…ì ì´ë¦„">
          </div>
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="tel" class="form-input" id="unitPhone" value="${data.phone || ''}" placeholder="010-0000-0000">
          </div>
          <div class="form-group">
            <label class="form-label">ì…ì£¼ì¼</label>
            <input type="date" class="form-input" id="unitMoveIn" value="${data.moveIn || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <input type="text" class="form-input" id="unitMemo" value="${data.memo || ''}" placeholder="ë©”ëª¨">
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveUnit()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

function renderMaterialList(app) {
  const suppliers = getUniqueSuppliers();
  let filtered = [...materials];
  
  if (supplierFilter !== 'all') {
    filtered = filtered.filter(m => m.supplier === supplierFilter);
  }
  
  if (searchText) {
    const s = searchText.toLowerCase();
    filtered = filtered.filter(m => 
      (m.name || '').toLowerCase().includes(s) ||
      (m.supplier || '').toLowerCase().includes(s)
    );
    filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
  }
  
  app.innerHTML = `
    <div class="header">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
        <div><h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1></div>
        <div style="display:flex;gap:8px;">
          <button onclick="openQuickModal()" style="background:#ff9800;border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;">âš¡</button>
          <button onclick="openGlobalSearch()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 12px;border-radius:8px;font-size:14px;">ğŸ”</button>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab active" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" placeholder="ğŸ” í’ˆëª©ëª…, êµ¬ì…ì²˜ ê²€ìƒ‰ (ê°€ê²© ë‚®ì€ìˆœ)..." value="${searchText}" oninput="searchText=this.value" onkeypress="if(event.key==='Enter'){addSearchHistory(searchText,'material');render();}">
      ${materialSearchHistory.length > 0 ? `
        <div class="search-history">
          <div class="search-history-title">ìµœê·¼ ê²€ìƒ‰</div>
          ${materialSearchHistory.map(h => `<span class="search-history-item" onclick="searchText='${h}';render();">${h}</span>`).join('')}
        </div>
      ` : ''}
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-size: 14px;">ì´ <b>${filtered.length}</b>ê°œ</span>
        <button class="btn btn-orange btn-sm" onclick="goMaterialForm()">+ ì¶”ê°€</button>
      </div>
      
      ${suppliers.length > 0 ? `
        <div style="margin-bottom: 12px;">
          <div style="font-size: 12px; color: #666; margin-bottom: 6px;">ğŸ“ êµ¬ì…ì²˜ë³„ ë³´ê¸°</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            <button class="filter-btn ${supplierFilter === 'all' ? 'active' : ''}" onclick="setSupplierFilter('all')">ì „ì²´</button>
            ${suppliers.map(s => `<button class="filter-btn ${supplierFilter === s ? 'active' : ''}" onclick="setSupplierFilter('${s}')">${s}</button>`).join('')}
          </div>
        </div>
      ` : ''}
    </div>
    
    <div class="card" style="margin-top:0;">
      <div class="card-body">
        ${filtered.length === 0 ? '<div class="empty">ë“±ë¡ëœ ìì¬ ì—†ìŒ</div>' : filtered.map(m => `
          <div class="material-item" style="display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
              <div class="material-name">
                ${m.name}
                ${m.supplier ? `<span class="supplier-badge">${m.supplier}</span>` : ''}
              </div>
              <div class="material-price">
                êµ¬ì… <b>${(m.price||0).toLocaleString()}</b>
                ${m.unitEa ? ` / ${m.unitEa}` : ''}
                â†’ ì²­êµ¬ <b>${(m.chargePrice||0).toLocaleString()}</b>
                <span style="color:#4caf50;font-weight:600;margin-left:8px;">+${((m.chargePrice||0)-(m.price||0)).toLocaleString()}</span>
              </div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-blue btn-sm" onclick="editMaterial('${m.id}')">ìˆ˜ì •</button>
              <button class="btn btn-red btn-sm" onclick="deleteMaterial('${m.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderMaterialForm(app) {
  const data = editData || { name: '', price: '', chargePrice: '', supplier: '', unitEa: '' };
  const suppliers = getUniqueSuppliers();
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'ìì¬ ìˆ˜ì •' : 'ìì¬ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í’ˆëª©ëª… *</label>
            <input type="text" class="form-input" id="matName" value="${data.name || ''}" placeholder="í’ˆëª©ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">êµ¬ì…ì²˜</label>
            ${suppliers.length > 0 ? `
              <div class="villa-grid" style="margin-bottom:8px;">
                ${suppliers.map(s => `<button type="button" class="villa-btn" onclick="document.getElementById('matSupplier').value='${s}'">${s}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="matSupplier" value="${data.supplier || ''}" placeholder="êµ¬ì…ì²˜ ì…ë ¥">
          </div>
          <div class="row-3">
            <div class="form-group">
              <label class="form-label">êµ¬ì…ê°€ *</label>
              <input type="number" class="form-input" id="matPrice" value="${data.price || ''}" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ì²­êµ¬ê°€ *</label>
              <input type="number" class="form-input" id="matChargePrice" value="${data.chargePrice || ''}" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ë‹¨ìœ„</label>
              <input type="text" class="form-input" id="matUnitEa" value="${data.unitEa || ''}" placeholder="10ea">
            </div>
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveMaterial()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

function renderGlobalSearch() {
  const app = document.getElementById('app');
  const s = searchText.toLowerCase();
  
  const matchedVillas = villas.filter(v => 
    (v.name || '').toLowerCase().includes(s) ||
    (v.address || '').toLowerCase().includes(s) ||
    (v.ownerPhone || '').includes(s)
  );
  
  const matchedRepairs = repairs.filter(r => 
    (r.villaName || '').toLowerCase().includes(s) ||
    (r.unit || '').toLowerCase().includes(s) ||
    (r.description || '').toLowerCase().includes(s) ||
    (r.address || '').toLowerCase().includes(s)
  );
  
  const matchedMaterials = materials.filter(m => 
    (m.name || '').toLowerCase().includes(s) ||
    (m.supplier || '').toLowerCase().includes(s)
  );
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="globalSearchMode=false;searchText='';render();">â†</button>
      <span class="back-title">ğŸ” "${searchText}" ê²€ìƒ‰ ê²°ê³¼</span>
    </div>
    
    <div style="padding:12px;">
      ${matchedVillas.length > 0 ? `
        <div class="card">
          <div class="card-header">ğŸ¢ ë¹Œë¼ (${matchedVillas.length})</div>
          <div class="card-body">
            ${matchedVillas.map(v => `
              <div style="padding:10px 0;border-bottom:1px solid #eee;">
                <div style="font-weight:600;">${v.name}</div>
                ${v.address ? `<div class="list-item-address" onclick="openNaverMap('${v.address}')" style="font-size:13px;">ğŸ“ ${v.address}</div>` : ''}
                ${v.ownerPhone ? `<a href="tel:${v.ownerPhone}" style="font-size:13px;color:#1565c0;">${v.ownerPhone}</a>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${matchedRepairs.length > 0 ? `
        <div class="card">
          <div class="card-header">ğŸ”§ A/S (${matchedRepairs.length})</div>
          <div class="card-body">
            ${matchedRepairs.map(r => `
              <div style="padding:10px 0;border-bottom:1px solid #eee;">
                <div><span style="font-weight:600;">${r.villaName}</span> <span class="unit-badge">${r.unit}</span></div>
                <div style="font-size:13px;color:#666;margin-top:4px;">${r.description || ''}</div>
                <div style="font-size:12px;color:#999;margin-top:4px;">${r.receiveDate || ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${matchedMaterials.length > 0 ? `
        <div class="card">
          <div class="card-header">ğŸ“¦ ìì¬ (${matchedMaterials.length})</div>
          <div class="card-body">
            ${matchedMaterials.map(m => `
              <div style="padding:10px 0;border-bottom:1px solid #eee;">
                <div style="font-weight:600;">${m.name} ${m.supplier ? `<span class="supplier-badge">${m.supplier}</span>` : ''}</div>
                <div style="font-size:13px;color:#666;">êµ¬ì… ${(m.price||0).toLocaleString()} ${m.unitEa ? `/ ${m.unitEa}` : ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${matchedVillas.length === 0 && matchedRepairs.length === 0 && matchedMaterials.length === 0 ? `
        <div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      ` : ''}
    </div>
  `;
}

// ===== í•¨ìˆ˜ë“¤ =====

function setTab(tab) { 
  currentTab = tab; 
  currentPage = 'list'; 
  selectedVilla = null; 
  searchText = ''; 
  globalSearchMode = false;
  render(); 
}
function setFilter(f) { filter = f; render(); }
function setDateFilter(d) { selectedDate = d; render(); }
function setSupplierFilter(s) { supplierFilter = s; render(); }
function goBack() { currentPage = 'list'; editData = null; render(); }
function goASForm() { editData = null; currentPage = 'asForm'; render(); }
function goVillaForm() { editData = null; currentPage = 'villaForm'; render(); }
function goUnitForm(villaId) { editData = { villaId }; currentPage = 'unitForm'; render(); }
function goMaterialForm() { editData = null; currentPage = 'materialForm'; render(); }

function openGlobalSearch() {
  const query = prompt('ì „ì²´ ê²€ìƒ‰ (ë¹Œë¼, A/S, ìì¬ ëª¨ë‘ ê²€ìƒ‰)');
  if (query && query.trim()) {
    searchText = query.trim();
    globalSearchMode = true;
    render();
  }
}

// ë¹ ë¥¸ ì ‘ìˆ˜ ëª¨ë‹¬
function openQuickModal() {
  document.getElementById('quickModal').style.display = 'flex';
  const input = document.getElementById('quickInput');
  input.focus();
  input.addEventListener('input', saveQuickDraft);
}

function closeQuickModal() {
  document.getElementById('quickModal').style.display = 'none';
}

function addTimeToQuick(time) {
  const input = document.getElementById('quickInput');
  input.value = input.value + ' ' + time;
  input.focus();
  saveQuickDraft();
}

// ìŒì„± ì¸ì‹
let recognition = null;
function startVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ko-KR';
  recognition.continuous = false;
  recognition.interimResults = false;
  
  const micBtn = document.getElementById('micBtn');
  micBtn.classList.add('recording');
  micBtn.textContent = 'ğŸ”´';
  
  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    document.getElementById('quickInput').value += ' ' + text;
    saveQuickDraft();
  };
  
  recognition.onend = () => {
    micBtn.classList.remove('recording');
    micBtn.textContent = 'ğŸ¤';
  };
  
  recognition.onerror = (event) => {
    micBtn.classList.remove('recording');
    micBtn.textContent = 'ğŸ¤';
    if (event.error !== 'no-speech') {
      alert('ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error);
    }
  };
  
  recognition.start();
}

// ë¹ ë¥¸ ì ‘ìˆ˜ ì œì¶œ
async function submitQuick() {
  const text = document.getElementById('quickInput').value.trim();
  if (!text) {
    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  const result = parseQuickText(text);
  
  const confirmMsg = `ğŸ“‹ ì¸ì‹ ê²°ê³¼\n\në¹Œë¼: ${result.villaName || '(ì¸ì‹ ì•ˆë¨)'}\ní˜¸ìˆ˜: ${result.unit || '(ì¸ì‹ ì•ˆë¨)'}\nì‹œê°„: ${result.visitTime || '(ì—†ìŒ)'}\në‚´ìš©: ${result.description || '(ì¸ì‹ ì•ˆë¨)'}\n\në“±ë¡í• ê¹Œìš”?`;
  
  if (confirm(confirmMsg)) {
    await saveQuickRepair(result);
    document.getElementById('quickInput').value = '';
    localStorage.removeItem('quickDraft');
    closeQuickModal();
  }
}

// í…ìŠ¤íŠ¸ íŒŒì‹±
function parseQuickText(text) {
  let villaName = '';
  let unit = '';
  let visitTime = '';
  let description = '';
  
  // ì‹œê°„ íŒ¨í„´ ì°¾ê¸°
  const timePatterns = [
    /ì˜¤ì „\s*\d{1,2}ì‹œ?(?:~\d{1,2}ì‹œ?)?/,
    /ì˜¤í›„\s*\d{1,2}ì‹œ?(?:~\d{1,2}ì‹œ?)?/,
    /\d{1,2}ì‹œ(?:~\d{1,2}ì‹œ)?/,
    /ì˜¤ì „/,
    /ì˜¤í›„/,
    /ë¯¸ì •/
  ];
  
  for (const pattern of timePatterns) {
    const match = text.match(pattern);
    if (match) {
      visitTime = match[0];
      text = text.replace(match[0], ' ').trim();
      break;
    }
  }
  
  // í˜¸ìˆ˜ ì°¾ê¸°
  const unitMatch = text.match(/(\d+)\s*í˜¸?/);
  if (unitMatch) {
    unit = unitMatch[1];
    text = text.replace(unitMatch[0], ' ').trim();
  }
  
  // ë“±ë¡ëœ ë¹Œë¼ëª… ì°¾ê¸°
  const sortedVillas = [...villas].sort((a, b) => (b.name?.length || 0) - (a.name?.length || 0));
  for (const v of sortedVillas) {
    if (v.name && text.includes(v.name)) {
      villaName = v.name;
      text = text.replace(v.name, ' ').trim();
      break;
    }
  }
  
  // ë¹Œë¼ëª… ëª» ì°¾ìœ¼ë©´ ì²« ë‹¨ì–´
  if (!villaName) {
    const words = text.split(/\s+/);
    if (words.length > 0) {
      villaName = words[0];
      text = words.slice(1).join(' ');
    }
  }
  
  description = text.trim();
  
  return { villaName, unit, visitTime, description };
}

// ë¹ ë¥¸ ì €ì¥
async function saveQuickRepair(data) {
  const villaName = data.villaName;
  const unit = data.unit;
  const description = data.description;
  const visitTime = data.visitTime || '';
  
  // ë¹Œë¼ ìë™ ë“±ë¡
  let existingVilla = villas.find(v => v.name === villaName);
  if (!existingVilla && villaName) {
    const villaId = 'v_' + Date.now();
    await db.collection('villas').doc(villaId).set({
      name: villaName, address: '', ownerPhone: ''
    });
    existingVilla = { id: villaId, name: villaName };
  }
  
  // í˜¸ìˆ˜ ìë™ ë“±ë¡
  if (existingVilla && unit) {
    const existingUnit = units.find(u => u.villaId === existingVilla.id && u.unit === unit);
    if (!existingUnit) {
      await db.collection('units').doc('u_' + Date.now()).set({
        villaId: existingVilla.id, unit: unit, phone: '', tenant: '', moveIn: '', memo: ''
      });
    }
  }
  
  // A/S ì €ì¥
  await db.collection('repairs').doc('r_' + Date.now()).set({
    villaName, unit, description, visitTime,
    receiveDate: today, status: 'ë¯¸ê²°',
    phone: '', ownerPhone: '', address: ''
  });
  
  alert('âœ… ë“±ë¡ ì™„ë£Œ!\n\n' + villaName + ' ' + unit + 'í˜¸\n' + (visitTime ? visitTime + '\n' : '') + description);
}

// API í‚¤ ì„¤ì •
let claudeApiKey = localStorage.getItem('claudeApiKey') || '';
function setApiKey() {
  const key = prompt('Claude API í‚¤ ì…ë ¥\n(https://console.anthropic.com)\n\ní˜„ì¬: ' + (claudeApiKey ? 'ì„¤ì •ë¨' : 'ì—†ìŒ'));
  if (key !== null) {
    claudeApiKey = key.trim();
    localStorage.setItem('claudeApiKey', claudeApiKey);
    alert(claudeApiKey ? 'API í‚¤ ì €ì¥ë¨!' : 'API í‚¤ ì‚­ì œë¨');
  }
}

// ë°©ë¬¸ ì‹œê°„ ì„¤ì •
let formVisitTime = '';
function setVisitTime(time) {
  const input = document.getElementById('visitTime');
  if (input.value.includes(time)) return;
  input.value = input.value ? input.value + ' ' + time : time;
  formVisitTime = input.value;
  
  document.querySelectorAll('.time-option').forEach(el => {
    if (el.textContent === time) el.classList.add('active');
  });
}

let formStatus = 'ë¯¸ê²°';
function setStatusForm(status) {
  formStatus = status;
  document.querySelectorAll('.status-option').forEach(el => {
    el.classList.remove('active');
    if (el.textContent === status) el.classList.add('active');
  });
}

function selectVillaAS(name) {
  document.getElementById('villaName').value = name;
  const villa = villas.find(v => v.name === name);
  if (villa) {
    if (villa.address) document.getElementById('address').value = villa.address;
    if (villa.ownerPhone) document.getElementById('ownerPhone').value = villa.ownerPhone;
  }
  editData = editData || {};
  editData.villaName = name;
  render();
}

function selectUnitAS(unit, phone) {
  document.getElementById('unit').value = unit;
  if (phone) document.getElementById('phone').value = phone;
}

async function saveRepair() {
  const villaName = document.getElementById('villaName').value.trim();
  const unit = document.getElementById('unit').value.trim();
  const description = document.getElementById('description').value.trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const phone = document.getElementById('phone').value.trim();
  const ownerPhone = document.getElementById('ownerPhone').value.trim();
  const address = document.getElementById('address').value.trim();
  const visitTime = document.getElementById('visitTime').value.trim();
  const status = formStatus || 'ë¯¸ê²°';
  
  if (!villaName || !unit || !description) {
    alert('ë¹Œë¼, í˜¸ìˆ˜, ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
    return;
  }
  
  // ë¹Œë¼ ìë™ ë“±ë¡/ì—…ë°ì´íŠ¸
  let existingVilla = villas.find(v => v.name === villaName);
  if (!existingVilla) {
    const villaId = 'v_' + Date.now();
    await db.collection('villas').doc(villaId).set({ name: villaName, address, ownerPhone });
    existingVilla = { id: villaId, name: villaName };
  } else if (address || ownerPhone) {
    const updates = {};
    if (address && !existingVilla.address) updates.address = address;
    if (ownerPhone && !existingVilla.ownerPhone) updates.ownerPhone = ownerPhone;
    if (Object.keys(updates).length > 0) {
      await db.collection('villas').doc(existingVilla.id).update(updates);
    }
  }
  
  // í˜¸ìˆ˜ ìë™ ë“±ë¡
  const existingUnit = units.find(u => u.villaId === existingVilla.id && u.unit === unit);
  if (!existingUnit) {
    await db.collection('units').doc('u_' + Date.now()).set({
      villaId: existingVilla.id, unit, phone, tenant: '', moveIn: '', memo: ''
    });
  } else if (phone && !existingUnit.phone) {
    await db.collection('units').doc(existingUnit.id).update({ phone });
  }
  
  const data = { villaName, unit, description, receiveDate, phone, ownerPhone, address, visitTime, status };
  
  try {
    if (editData?.id) {
      await db.collection('repairs').doc(editData.id).update(data);
    } else {
      await db.collection('repairs').doc('r_' + Date.now()).set(data);
    }
    editData = null;
    formStatus = 'ë¯¸ê²°';
    formVisitTime = '';
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editRepair(id) {
  editData = repairs.find(r => r.id === id);
  formStatus = editData?.status || 'ë¯¸ê²°';
  formVisitTime = editData?.visitTime || '';
  currentPage = 'asForm';
  render();
}

async function toggleStatus(id) {
  const r = repairs.find(r => r.id === id);
  if (r) await db.collection('repairs').doc(id).update({ status: r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°' : 'ì™„ë£Œ' });
}

async function deleteRepair(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('repairs').doc(id).delete();
}

function selectVillaView(id) { selectedVilla = villas.find(v => v.id === id); render(); }

async function saveVilla() {
  const name = document.getElementById('villaNameInput').value.trim();
  const address = document.getElementById('villaAddress').value.trim();
  const ownerPhone = document.getElementById('villaOwnerPhone').value.trim();
  
  if (!name) { alert('ë¹Œë¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }
  
  try {
    if (editData?.id) {
      await db.collection('villas').doc(editData.id).update({ name, address, ownerPhone });
    } else {
      await db.collection('villas').doc('v_' + Date.now()).set({ name, address, ownerPhone });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editVilla(id) { editData = villas.find(v => v.id === id); currentPage = 'villaForm'; render(); }

async function deleteVilla(id) {
  if (confirm('ë¹Œë¼ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
    await db.collection('villas').doc(id).delete();
    for (const u of units.filter(u => u.villaId === id)) {
      await db.collection('units').doc(u.id).delete();
    }
    selectedVilla = null;
    render();
  }
}

async function saveUnit() {
  const unit = document.getElementById('unitNum').value.trim();
  const tenant = document.getElementById('unitTenant').value.trim();
  const phone = document.getElementById('unitPhone').value.trim();
  const moveIn = document.getElementById('unitMoveIn').value;
  const memo = document.getElementById('unitMemo').value.trim();
  
  if (!unit) { alert('í˜¸ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }
  
  try {
    if (editData?.id) {
      await db.collection('units').doc(editData.id).update({ unit, tenant, phone, moveIn, memo });
    } else {
      await db.collection('units').doc('u_' + Date.now()).set({ unit, tenant, phone, moveIn, memo, villaId: editData.villaId });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editUnit(id) {
  const u = units.find(u => u.id === id);
  editData = { ...u };
  currentPage = 'unitForm';
  render();
}

async function deleteUnit(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('units').doc(id).delete();
}

async function saveMaterial() {
  const name = document.getElementById('matName').value.trim();
  const supplier = document.getElementById('matSupplier').value.trim();
  const price = parseInt(document.getElementById('matPrice').value) || 0;
  const chargePrice = parseInt(document.getElementById('matChargePrice').value) || 0;
  const unitEa = document.getElementById('matUnitEa').value.trim();
  
  if (!name || !price || !chargePrice) { alert('í’ˆëª©ëª…, êµ¬ì…ê°€, ì²­êµ¬ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  
  try {
    const data = { name, supplier, price, chargePrice, unitEa };
    if (editData?.id) {
      await db.collection('materials').doc(editData.id).update(data);
    } else {
      await db.collection('materials').doc('m_' + Date.now()).set(data);
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editMaterial(id) {
  editData = materials.find(m => m.id === id);
  currentPage = 'materialForm';
  render();
}

async function deleteMaterial(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('materials').doc(id).delete();
}

setTimeout(render, 1000);
</script>

</body>
</html>
