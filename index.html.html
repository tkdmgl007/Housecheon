<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¹Œë¼ ê´€ë¦¬</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Pretendard', -apple-system, sans-serif; 
      background: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%);
      min-height: 100vh;
    }
    
    /* í—¤ë” */
    .header {
      background: linear-gradient(90deg, #00695c, #00897b);
      color: white;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header-sub { font-size: 11px; opacity: 0.9; margin-top: 2px; }
    .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
    
    /* íƒ­ ë©”ë‰´ */
    .tabs {
      display: flex;
      background: #004d40;
    }
    .tab {
      flex: 1;
      padding: 14px 8px;
      text-align: center;
      color: white;
      border: none;
      background: transparent;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      background: #00796b;
      border-bottom-color: #ffb300;
    }
    
    /* ì¹´ë“œ */
    .card {
      background: white;
      border-radius: 10px;
      margin: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .card-header {
      background: #37474f;
      color: white;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-body { padding: 14px; }
    
    /* í¼ */
    .form-group { margin-bottom: 14px; }
    .form-label { font-size: 13px; color: #666; margin-bottom: 6px; display: block; font-weight: 500; }
    .form-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-input:focus { border-color: #00897b; }
    textarea.form-input { min-height: 100px; resize: vertical; }
    
    /* ë²„íŠ¼ */
    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-orange { background: #ff9800; color: white; }
    .btn-green { background: #4caf50; color: white; }
    .btn-blue { background: #2196f3; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-gray { background: #9e9e9e; color: white; }
    .btn-block { width: 100%; }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    
    /* ì¹© ë²„íŠ¼ */
    .chip {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin: 4px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .chip-teal { background: #e0f2f1; color: #00695c; }
    .chip-teal.active { background: #00695c; color: white; }
    .chip-green { background: #e8f5e9; color: #2e7d32; }
    .chip-green.active { background: #2e7d32; color: white; }
    
    /* í•„í„° ë²„íŠ¼ */
    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      margin-right: 8px;
      cursor: pointer;
    }
    .filter-btn.active { background: #00695c; color: white; }
    .filter-btn:not(.active) { background: white; color: #00695c; }
    
    /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
    .list-item {
      background: white;
      border-radius: 10px;
      padding: 14px;
      margin: 10px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #ff9800;
    }
    .list-item.done { border-left-color: #4caf50; }
    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .villa-name { font-weight: 700; font-size: 16px; }
    .unit-badge {
      background: #1565c0;
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      margin-left: 8px;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-badge.pending { background: #fff3e0; color: #e65100; }
    .status-badge.done { background: #e8f5e9; color: #2e7d32; }
    .list-item-desc { color: #333; font-size: 14px; line-height: 1.5; margin-bottom: 10px; }
    .list-item-date { font-size: 11px; color: #999; }
    
    /* ì „í™” ë²„íŠ¼ */
    .phone-btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      text-decoration: none;
      margin-right: 6px;
      margin-top: 6px;
    }
    .phone-btn.owner { background: #fff3e0; color: #e65100; }
    .phone-btn.tenant { background: #e8f5e9; color: #2e7d32; }
    
    /* ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ */
    .action-btns {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .action-btn {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    
    /* ë¹Œë¼ ê·¸ë¦¬ë“œ */
    .villa-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .villa-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: white;
      color: #00695c;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .villa-btn.active { background: #00695c; color: white; }
    
    /* í˜¸ìˆ˜ í…Œì´ë¸” */
    .unit-table {
      width: 100%;
      border-collapse: collapse;
    }
    .unit-table th {
      background: #607d8b;
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-size: 13px;
      font-weight: 500;
    }
    .unit-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    .unit-num {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
    }
    
    /* ìƒíƒœ ì„ íƒ */
    .status-select {
      display: flex;
      gap: 10px;
    }
    .status-option {
      flex: 1;
      padding: 14px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }
    .status-option.pending { background: #eee; color: #666; }
    .status-option.pending.active { background: #ff9800; color: white; }
    .status-option.done { background: #eee; color: #666; }
    .status-option.done.active { background: #4caf50; color: white; }
    
    /* ë¡œë”© */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 100%);
    }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
    .loading-text { color: #00695c; font-size: 16px; }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    /* ë’¤ë¡œê°€ê¸° í—¤ë” */
    .back-header {
      background: #00695c;
      color: white;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }
    .back-title { font-size: 18px; font-weight: 600; }
    
    /* ë¹Œë¼ ì •ë³´ ë°•ìŠ¤ */
    .villa-info {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .villa-info-row { margin-bottom: 4px; }
    .villa-info a { color: #1565c0; text-decoration: none; }

    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ff9800;
      color: white;
      border: none;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 50;
    }

    /* ë‘ ì¤„ ì…ë ¥ */
    .row-2 {
      display: flex;
      gap: 12px;
    }
    .row-2 > div { flex: 1; }
    
    /* ìˆ¨ê¹€ */
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="app">
  <div class="loading">
    <div class="loading-icon">ğŸ </div>
    <div class="loading-text">ì—°ê²° ì¤‘...</div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase ì„¤ì •
const firebaseConfig = {
  apiKey: "AIzaSyBrMcbN2Iv3hjBW0uQx7_gSXAWcwTTSgGI",
  authDomain: "villa-management-4af75.firebaseapp.com",
  projectId: "villa-management-4af75",
  storageBucket: "villa-management-4af75.firebasestorage.app",
  messagingSenderId: "994416353525",
  appId: "1:994416353525:web:3bd200acc5d68f6df065bc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ìƒíƒœ
let currentPage = 'list';
let currentTab = 'as';
let filter = 'ë¯¸ê²°';
let villas = [];
let units = [];
let repairs = [];
let materials = [];
let editData = null;
let selectedVilla = null;

// ì‹¤ì‹œê°„ êµ¬ë…
db.collection('villas').onSnapshot(snap => {
  villas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('units').onSnapshot(snap => {
  units = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('repairs').onSnapshot(snap => {
  repairs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('materials').onSnapshot(snap => {
  materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

// ì˜¤ëŠ˜ ë‚ ì§œ
const today = new Date().toISOString().split('T')[0];

// ë Œë”ë§
function render() {
  const app = document.getElementById('app');
  
  if (currentPage === 'list') {
    if (currentTab === 'as') renderASList(app);
    else if (currentTab === 'villa') renderVillaList(app);
    else if (currentTab === 'material') renderMaterialList(app);
  } else if (currentPage === 'asForm') {
    renderASForm(app);
  } else if (currentPage === 'villaForm') {
    renderVillaForm(app);
  } else if (currentPage === 'unitForm') {
    renderUnitForm(app);
  } else if (currentPage === 'materialForm') {
    renderMaterialForm(app);
  }
}

// A/S ëª©ë¡
function renderASList(app) {
  const filtered = repairs
    .filter(r => filter === 'ì „ì²´' ? true : r.status === filter)
    .sort((a, b) => (b.receiveDate || '').localeCompare(a.receiveDate || ''));
  
  app.innerHTML = `
    <div class="header">
      <div>
        <h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1>
        <div class="header-sub">ë¹Œë¼ ${villas.length} | ìˆ˜ë¦¬ ${repairs.length} | ìì¬ ${materials.length}</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div style="padding: 12px; display: flex; flex-wrap: wrap; align-items: center;">
      <button class="filter-btn ${filter === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setFilter('ë¯¸ê²°')">ë¯¸ê²° (${repairs.filter(r => r.status === 'ë¯¸ê²°').length})</button>
      <button class="filter-btn ${filter === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setFilter('ì™„ë£Œ')">ì™„ë£Œ (${repairs.filter(r => r.status === 'ì™„ë£Œ').length})</button>
      <button class="filter-btn ${filter === 'ì „ì²´' ? 'active' : ''}" onclick="setFilter('ì „ì²´')">ì „ì²´ (${repairs.length})</button>
      <button class="btn btn-orange btn-sm" style="margin-left: auto;" onclick="goASForm()">+ ì ‘ìˆ˜</button>
    </div>
    
    ${filtered.length === 0 ? '<div class="empty">ì ‘ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' : filtered.map(r => `
      <div class="list-item ${r.status === 'ì™„ë£Œ' ? 'done' : ''}">
        <div class="list-item-header">
          <div>
            <span class="villa-name">${r.villaName || ''}</span>
            <span class="unit-badge">${r.unit || ''}</span>
            <span class="status-badge ${r.status === 'ì™„ë£Œ' ? 'done' : 'pending'}">${r.status || 'ë¯¸ê²°'}</span>
          </div>
          <div class="list-item-date">${r.receiveDate || ''}</div>
        </div>
        <div class="list-item-desc">${r.description || ''}</div>
        <div>
          ${r.ownerPhone ? `<a href="tel:${r.ownerPhone}" class="phone-btn owner">ê±´ë¬¼ì£¼ ğŸ“</a><a href="sms:${r.ownerPhone}" class="phone-btn owner">ë¬¸ì</a>` : ''}
          ${r.phone ? `<a href="tel:${r.phone}" class="phone-btn tenant">ì„¸ì…ì ğŸ“</a><a href="sms:${r.phone}" class="phone-btn tenant">ë¬¸ì</a>` : ''}
        </div>
        <div class="action-btns">
          <button class="action-btn btn-${r.status === 'ì™„ë£Œ' ? 'orange' : 'green'}" onclick="toggleStatus('${r.id}')">${r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°ë¡œ' : 'ì™„ë£Œë¡œ'}</button>
          <button class="action-btn btn-blue" onclick="editRepair('${r.id}')">ìˆ˜ì •</button>
          <button class="action-btn btn-red" onclick="deleteRepair('${r.id}')">ì‚­ì œ</button>
        </div>
      </div>
    `).join('')}
  `;
}

// A/S í¼
function renderASForm(app) {
  const data = editData || { villaName: '', unit: '', description: '', receiveDate: today, status: 'ë¯¸ê²°', phone: '', ownerPhone: '' };
  const villaUnits = data.villaName ? units.filter(u => villas.find(v => v.id === u.villaId)?.name === data.villaName) : [];
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData ? 'A/S ìˆ˜ì •' : 'A/S ì ‘ìˆ˜'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ì ‘ìˆ˜ì¼</label>
            <input type="date" class="form-input" id="receiveDate" value="${data.receiveDate}">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ *</label>
            <div class="villa-grid">
              ${villas.map(v => `<button class="villa-btn ${data.villaName === v.name ? 'active' : ''}" onclick="selectVilla('${v.name}', '${v.ownerPhone || ''}')">${v.name}</button>`).join('')}
            </div>
            <input type="text" class="form-input" id="villaName" value="${data.villaName}" placeholder="ì§ì ‘ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            ${villaUnits.length > 0 ? `<div class="villa-grid">${villaUnits.map(u => `<button class="villa-btn ${data.unit === u.unit ? 'active' : ''}" style="background:${data.unit === u.unit ? '#2e7d32' : 'white'}; color:${data.unit === u.unit ? 'white' : '#2e7d32'}" onclick="selectUnit('${u.unit}', '${u.phone || ''}')">${u.unit}</button>`).join('')}</div>` : ''}
            <input type="text" class="form-input" id="unit" value="${data.unit}" placeholder="í˜¸ìˆ˜ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <textarea class="form-input" id="description" placeholder="ìˆ˜ë¦¬ ë‚´ìš©">${data.description}</textarea>
          </div>
          
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">ì„¸ì…ì ì „í™”</label>
              <input type="tel" class="form-input" id="phone" value="${data.phone}" placeholder="010-0000-0000">
            </div>
            <div class="form-group">
              <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
              <input type="tel" class="form-input" id="ownerPhone" value="${data.ownerPhone}" placeholder="010-0000-0000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒíƒœ</label>
            <div class="status-select">
              <button class="status-option pending ${data.status === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setStatus('ë¯¸ê²°')">ë¯¸ê²°</button>
              <button class="status-option done ${data.status === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setStatus('ì™„ë£Œ')">ì™„ë£Œ</button>
            </div>
          </div>
          
          <button class="btn btn-orange btn-block" onclick="saveRepair()" style="margin-top: 10px;">
            ${editData ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì ‘ìˆ˜í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  `;
}

// ë¹Œë¼ ëª©ë¡
function renderVillaList(app) {
  const villaUnits = selectedVilla ? units.filter(u => u.villaId === selectedVilla.id).sort((a,b) => (parseInt(a.unit)||0) - (parseInt(b.unit)||0)) : [];
  
  app.innerHTML = `
    <div class="header">
      <div>
        <h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab active" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-weight: 600; color: #00695c;">ë¹Œë¼ ëª©ë¡ (${villas.length})</span>
        <button class="btn btn-orange btn-sm" onclick="goVillaForm()">+ ë¹Œë¼ì¶”ê°€</button>
      </div>
      
      <div class="villa-grid">
        ${villas.map(v => `<button class="villa-btn ${selectedVilla?.id === v.id ? 'active' : ''}" onclick="selectVillaView('${v.id}')">${v.name}</button>`).join('')}
      </div>
    </div>
    
    ${selectedVilla ? `
      <div class="card">
        <div class="card-header">
          <span>${selectedVilla.name}</span>
          <div>
            <button class="btn btn-blue btn-sm" onclick="editVilla('${selectedVilla.id}')" style="margin-right:4px;">ìˆ˜ì •</button>
            <button class="btn btn-green btn-sm" onclick="goUnitForm('${selectedVilla.id}')" style="margin-right:4px;">+í˜¸ìˆ˜</button>
            <button class="btn btn-red btn-sm" onclick="deleteVilla('${selectedVilla.id}')">ì‚­ì œ</button>
          </div>
        </div>
        <div class="villa-info">
          <div class="villa-info-row">ğŸ“ ${selectedVilla.address || '-'}</div>
          <div class="villa-info-row">ğŸ‘¤ ê±´ë¬¼ì£¼ ${selectedVilla.ownerPhone ? `<a href="tel:${selectedVilla.ownerPhone}">${selectedVilla.ownerPhone}</a>` : '-'}</div>
        </div>
        <div class="card-body" style="padding-top:0;">
          <table class="unit-table">
            <thead>
              <tr>
                <th style="width:70px;">í˜¸ìˆ˜</th>
                <th>ì„¸ì…ì / ì—°ë½ì²˜</th>
                <th style="width:80px;">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${villaUnits.length === 0 ? '<tr><td colspan="3" style="text-align:center;color:#999;padding:20px;">ë“±ë¡ëœ í˜¸ìˆ˜ ì—†ìŒ</td></tr>' : villaUnits.map(u => `
                <tr>
                  <td><span class="unit-num">${u.unit}</span></td>
                  <td>
                    <div style="font-weight:600;">${u.tenant || '(ê³µì‹¤)'}</div>
                    ${u.phone ? `<a href="tel:${u.phone}" style="color:#1565c0;font-size:13px;">${u.phone}</a>` : ''}
                    ${u.moveIn ? `<div style="font-size:11px;color:#888;margin-top:2px;">ì…ì£¼: ${u.moveIn}</div>` : ''}
                  </td>
                  <td>
                    <button class="btn btn-blue btn-sm" onclick="editUnit('${u.id}')" style="margin-bottom:4px;display:block;width:100%;">ìˆ˜ì •</button>
                    <button class="btn btn-red btn-sm" onclick="deleteUnit('${u.id}')" style="display:block;width:100%;">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    ` : ''}
  `;
}

// ë¹Œë¼ í¼
function renderVillaForm(app) {
  const data = editData || { name: '', address: '', ownerPhone: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'ë¹Œë¼ ìˆ˜ì •' : 'ë¹Œë¼ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ëª… *</label>
            <input type="text" class="form-input" id="villaNameInput" value="${data.name}" placeholder="ë¹Œë¼ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="villaAddress" value="${data.address || ''}" placeholder="ì£¼ì†Œ">
          </div>
          <div class="form-group">
            <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
            <input type="tel" class="form-input" id="villaOwnerPhone" value="${data.ownerPhone || ''}" placeholder="010-0000-0000">
          </div>
          <button class="btn btn-orange btn-block" onclick="saveVilla()" style="margin-top: 10px;">
            ${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  `;
}

// í˜¸ìˆ˜ í¼
function renderUnitForm(app) {
  const data = editData || { unit: '', tenant: '', phone: '', moveIn: '', memo: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'í˜¸ìˆ˜ ìˆ˜ì •' : 'í˜¸ìˆ˜ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            <input type="text" class="form-input" id="unitNum" value="${data.unit}" placeholder="101">
          </div>
          <div class="form-group">
            <label class="form-label">ì„¸ì…ì</label>
            <input type="text" class="form-input" id="unitTenant" value="${data.tenant || ''}" placeholder="ì„¸ì…ì ì´ë¦„">
          </div>
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="tel" class="form-input" id="unitPhone" value="${data.phone || ''}" placeholder="010-0000-0000">
          </div>
          <div class="form-group">
            <label class="form-label">ì…ì£¼ì¼</label>
            <input type="date" class="form-input" id="unitMoveIn" value="${data.moveIn || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <input type="text" class="form-input" id="unitMemo" value="${data.memo || ''}" placeholder="ë©”ëª¨">
          </div>
          <button class="btn btn-orange btn-block" onclick="saveUnit()" style="margin-top: 10px;">
            ${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  `;
}

// ìì¬ ëª©ë¡
function renderMaterialList(app) {
  const totalProfit = materials.reduce((sum, m) => sum + (m.profit || 0), 0);
  
  app.innerHTML = `
    <div class="header">
      <div>
        <h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab active" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-size: 14px;">ì´ <b>${materials.length}</b>ê°œ | ì´ìµ <b style="color:#4caf50;">+${totalProfit.toLocaleString()}ì›</b></span>
        <button class="btn btn-orange btn-sm" onclick="goMaterialForm()">+ ì¶”ê°€</button>
      </div>
    </div>
    
    <div class="card" style="margin-top:0;">
      <div class="card-body">
        ${materials.length === 0 ? '<div class="empty">ë“±ë¡ëœ ìì¬ ì—†ìŒ</div>' : materials.map(m => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">
            <div>
              <div style="font-weight:600;">${m.name}</div>
              <div style="font-size:13px;color:#666;">êµ¬ì… ${(m.price||0).toLocaleString()} â†’ ì²­êµ¬ ${(m.chargePrice||0).toLocaleString()}</div>
              <div style="font-size:13px;color:#4caf50;font-weight:600;">ì´ìµ +${(m.profit||0).toLocaleString()}</div>
            </div>
            <button class="btn btn-red btn-sm" onclick="deleteMaterial('${m.id}')">ì‚­ì œ</button>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// ìì¬ í¼
function renderMaterialForm(app) {
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">ìì¬ ì¶”ê°€</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í’ˆëª©ëª… *</label>
            <input type="text" class="form-input" id="matName" placeholder="í’ˆëª©ëª…">
          </div>
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">êµ¬ì…ê°€ *</label>
              <input type="number" class="form-input" id="matPrice" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ì²­êµ¬ê°€ *</label>
              <input type="number" class="form-input" id="matChargePrice" placeholder="0">
            </div>
          </div>
          <button class="btn btn-orange btn-block" onclick="saveMaterial()" style="margin-top: 10px;">ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>
    </div>
  `;
}

// === í•¨ìˆ˜ë“¤ ===

function setTab(tab) {
  currentTab = tab;
  currentPage = 'list';
  selectedVilla = null;
  render();
}

function setFilter(f) {
  filter = f;
  render();
}

function goBack() {
  currentPage = 'list';
  editData = null;
  render();
}

function goASForm() {
  editData = null;
  currentPage = 'asForm';
  render();
}

function goVillaForm() {
  editData = null;
  currentPage = 'villaForm';
  render();
}

function goUnitForm(villaId) {
  editData = { villaId: villaId };
  currentPage = 'unitForm';
  render();
}

function goMaterialForm() {
  currentPage = 'materialForm';
  render();
}

// A/S ê´€ë ¨
let formData = {};

function selectVilla(name, ownerPhone) {
  document.getElementById('villaName').value = name;
  document.getElementById('ownerPhone').value = ownerPhone || '';
  formData.villaName = name;
  formData.ownerPhone = ownerPhone;
  render();
}

function selectUnit(unit, phone) {
  document.getElementById('unit').value = unit;
  document.getElementById('phone').value = phone || '';
}

function setStatus(status) {
  formData.status = status;
  const pending = document.querySelector('.status-option.pending');
  const done = document.querySelector('.status-option.done');
  if (status === 'ë¯¸ê²°') {
    pending.classList.add('active');
    done.classList.remove('active');
  } else {
    done.classList.add('active');
    pending.classList.remove('active');
  }
}

async function saveRepair() {
  const villaName = document.getElementById('villaName').value;
  const unit = document.getElementById('unit').value;
  const description = document.getElementById('description').value;
  const receiveDate = document.getElementById('receiveDate').value;
  const phone = document.getElementById('phone').value;
  const ownerPhone = document.getElementById('ownerPhone').value;
  const status = formData.status || (editData?.status) || 'ë¯¸ê²°';
  
  if (!villaName || !unit || !description) {
    alert('ë¹Œë¼, í˜¸ìˆ˜, ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
    return;
  }
  
  const data = { villaName, unit, description, receiveDate, phone, ownerPhone, status };
  
  try {
    if (editData?.id) {
      await db.collection('repairs').doc(editData.id).update(data);
    } else {
      await db.collection('repairs').doc('r_' + Date.now()).set(data);
    }
    editData = null;
    formData = {};
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editRepair(id) {
  editData = repairs.find(r => r.id === id);
  formData.status = editData?.status || 'ë¯¸ê²°';
  currentPage = 'asForm';
  render();
}

async function toggleStatus(id) {
  const r = repairs.find(r => r.id === id);
  if (r) {
    await db.collection('repairs').doc(id).update({ status: r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°' : 'ì™„ë£Œ' });
  }
}

async function deleteRepair(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) {
    await db.collection('repairs').doc(id).delete();
  }
}

// ë¹Œë¼ ê´€ë ¨
function selectVillaView(id) {
  selectedVilla = villas.find(v => v.id === id);
  render();
}

async function saveVilla() {
  const name = document.getElementById('villaNameInput').value;
  const address = document.getElementById('villaAddress').value;
  const ownerPhone = document.getElementById('villaOwnerPhone').value;
  
  if (!name) {
    alert('ë¹Œë¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
    return;
  }
  
  try {
    if (editData?.id) {
      await db.collection('villas').doc(editData.id).update({ name, address, ownerPhone });
    } else {
      await db.collection('villas').doc('v_' + Date.now()).set({ name, address, ownerPhone });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editVilla(id) {
  editData = villas.find(v => v.id === id);
  currentPage = 'villaForm';
  render();
}

async function deleteVilla(id) {
  if (confirm('ë¹Œë¼ë¥¼ ì‚­ì œí• ê¹Œìš”? í˜¸ìˆ˜ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
    await db.collection('villas').doc(id).delete();
    const villaUnits = units.filter(u => u.villaId === id);
    for (const u of villaUnits) {
      await db.collection('units').doc(u.id).delete();
    }
    selectedVilla = null;
    render();
  }
}

// í˜¸ìˆ˜ ê´€ë ¨
async function saveUnit() {
  const unit = document.getElementById('unitNum').value;
  const tenant = document.getElementById('unitTenant').value;
  const phone = document.getElementById('unitPhone').value;
  const moveIn = document.getElementById('unitMoveIn').value;
  const memo = document.getElementById('unitMemo').value;
  
  if (!unit) {
    alert('í˜¸ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤');
    return;
  }
  
  try {
    if (editData?.id) {
      await db.collection('units').doc(editData.id).update({ unit, tenant, phone, moveIn, memo });
    } else {
      await db.collection('units').doc('u_' + Date.now()).set({ unit, tenant, phone, moveIn, memo, villaId: editData.villaId });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editUnit(id) {
  const u = units.find(u => u.id === id);
  editData = { ...u, villaId: u.villaId };
  currentPage = 'unitForm';
  render();
}

async function deleteUnit(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) {
    await db.collection('units').doc(id).delete();
  }
}

// ìì¬ ê´€ë ¨
async function saveMaterial() {
  const name = document.getElementById('matName').value;
  const price = parseInt(document.getElementById('matPrice').value) || 0;
  const chargePrice = parseInt(document.getElementById('matChargePrice').value) || 0;
  
  if (!name || !price || !chargePrice) {
    alert('ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  try {
    await db.collection('materials').doc('m_' + Date.now()).set({
      name, price, chargePrice, profit: chargePrice - price
    });
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

async function deleteMaterial(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) {
    await db.collection('materials').doc(id).delete();
  }
}

// ì´ˆê¸° ë Œë”ë§
setTimeout(render, 1500);
</script>

</body>
</html>
