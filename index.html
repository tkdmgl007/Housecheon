<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¹Œë¼ ê´€ë¦¬</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%);
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(90deg, #00695c, #00897b);
      color: white;
      padding: 14px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header-sub { font-size: 11px; opacity: 0.9; margin-top: 2px; }
    
    .tabs { display: flex; background: #004d40; }
    .tab {
      flex: 1; padding: 14px 8px; text-align: center; color: white; border: none;
      background: transparent; font-size: 14px; font-weight: 500; cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active { background: #00796b; border-bottom-color: #ffb300; }
    
    .card {
      background: white; border-radius: 10px; margin: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;
    }
    .card-header {
      background: #37474f; color: white; padding: 12px 14px;
      font-size: 15px; font-weight: 600;
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-body { padding: 14px; }
    
    .form-group { margin-bottom: 14px; }
    .form-label { font-size: 13px; color: #666; margin-bottom: 6px; display: block; font-weight: 500; }
    .form-input {
      width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 16px; outline: none;
    }
    .form-input:focus { border-color: #00897b; }
    textarea.form-input { min-height: 80px; resize: vertical; }
    
    .btn {
      padding: 12px 18px; border: none; border-radius: 8px;
      font-size: 15px; font-weight: 600; cursor: pointer;
    }
    .btn-orange { background: #ff9800; color: white; }
    .btn-green { background: #4caf50; color: white; }
    .btn-blue { background: #2196f3; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-block { width: 100%; }
    .btn-sm { padding: 8px 12px; font-size: 13px; }
    
    .chip {
      display: inline-block; padding: 8px 14px; border-radius: 20px;
      font-size: 14px; font-weight: 600; margin: 3px; cursor: pointer; border: none;
    }
    .chip-teal { background: #e0f2f1; color: #00695c; }
    .chip-teal.active { background: #00695c; color: white; }
    
    .filter-btn {
      padding: 8px 14px; border-radius: 20px; border: none;
      font-size: 13px; font-weight: 600; margin-right: 6px; margin-bottom: 6px; cursor: pointer;
    }
    .filter-btn.active { background: #00695c; color: white; }
    .filter-btn:not(.active) { background: white; color: #00695c; }
    
    .list-item {
      background: white; border-radius: 10px; padding: 14px;
      margin: 10px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #ff9800;
    }
    .list-item.done { border-left-color: #4caf50; }
    .villa-name { font-weight: 700; font-size: 16px; }
    .unit-badge {
      background: #1565c0; color: white; padding: 4px 10px;
      border-radius: 6px; font-size: 13px; font-weight: 600; margin-left: 8px;
    }
    .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-badge.pending { background: #fff3e0; color: #e65100; }
    .status-badge.done { background: #e8f5e9; color: #2e7d32; }
    .list-item-desc { color: #333; font-size: 14px; line-height: 1.5; margin: 8px 0; }
    .list-item-date { font-size: 11px; color: #999; }
    .list-item-address { font-size: 12px; color: #666; margin-top: 4px; }
    
    .phone-btn {
      display: inline-block; padding: 6px 12px; border-radius: 6px;
      font-size: 12px; text-decoration: none; margin-right: 6px; margin-top: 6px;
    }
    .phone-btn.owner { background: #fff3e0; color: #e65100; }
    .phone-btn.tenant { background: #e8f5e9; color: #2e7d32; }
    
    .action-btns { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .action-btn {
      padding: 8px 14px; border-radius: 6px; border: none;
      font-size: 13px; font-weight: 500; cursor: pointer;
    }
    
    .search-box {
      background: white; margin: 12px; border-radius: 10px; padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .search-input {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 15px; outline: none;
    }
    .search-input:focus { border-color: #00897b; }
    
    .date-filter {
      display: flex; gap: 8px; padding: 12px; overflow-x: auto;
      flex-wrap: wrap;
    }
    .date-btn {
      padding: 8px 14px; border-radius: 20px; border: none;
      font-size: 13px; font-weight: 500; cursor: pointer;
      white-space: nowrap;
    }
    .date-btn.active { background: #00695c; color: white; }
    .date-btn:not(.active) { background: white; color: #333; }
    
    .back-header {
      background: #00695c; color: white; padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
      position: sticky; top: 0; z-index: 100;
    }
    .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
    .back-title { font-size: 18px; font-weight: 600; }
    
    .villa-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .villa-btn {
      padding: 10px 14px; border-radius: 8px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer;
      background: white; color: #00695c; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .villa-btn.active { background: #00695c; color: white; }
    
    .row-2 { display: flex; gap: 12px; }
    .row-2 > div { flex: 1; }
    
    .status-select { display: flex; gap: 10px; }
    .status-option {
      flex: 1; padding: 14px; border-radius: 8px; border: none;
      font-size: 16px; font-weight: 600; cursor: pointer; text-align: center;
    }
    .status-option.pending { background: #eee; color: #666; }
    .status-option.pending.active { background: #ff9800; color: white; }
    .status-option.done { background: #eee; color: #666; }
    .status-option.done.active { background: #4caf50; color: white; }
    
    .loading {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 100vh;
    }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
    .loading-text { color: #00695c; font-size: 16px; }
    
    .empty { text-align: center; padding: 40px 20px; color: #999; }
    
    .supplier-badge {
      display: inline-block; background: #e3f2fd; color: #1565c0;
      padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px;
    }
    
    .search-history {
      margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
    }
    .search-history-title { font-size: 12px; color: #999; margin-bottom: 8px; }
    .search-history-item {
      display: inline-block; background: #f5f5f5; padding: 6px 12px;
      border-radius: 16px; font-size: 13px; margin: 3px; cursor: pointer;
    }
    
    .unit-table { width: 100%; border-collapse: collapse; }
    .unit-table th {
      background: #607d8b; color: white; padding: 10px 8px;
      text-align: left; font-size: 13px;
    }
    .unit-table td { padding: 12px 8px; border-bottom: 1px solid #eee; }
    .unit-num {
      display: inline-block; background: #e3f2fd; color: #1565c0;
      padding: 6px 12px; border-radius: 6px; font-weight: 700;
    }

    .villa-info {
      background: #f5f5f5; padding: 12px; border-radius: 8px;
      margin-bottom: 12px; font-size: 13px;
    }
  </style>
</head>
<body>

<div id="app">
  <div class="loading">
    <div class="loading-icon">ğŸ </div>
    <div class="loading-text">ì—°ê²° ì¤‘...</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBrMcbN2Iv3hjBW0uQx7_gSXAWcwTTSgGI",
  authDomain: "villa-management-4af75.firebaseapp.com",
  projectId: "villa-management-4af75",
  storageBucket: "villa-management-4af75.firebasestorage.app",
  messagingSenderId: "994416353525",
  appId: "1:994416353525:web:3bd200acc5d68f6df065bc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentPage = 'list';
let currentTab = 'as';
let filter = 'ë¯¸ê²°';
let selectedDate = 'all';
let villas = [];
let units = [];
let repairs = [];
let materials = [];
let editData = null;
let selectedVilla = null;
let searchText = '';
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
let supplierFilter = 'all';

const today = new Date().toISOString().split('T')[0];

db.collection('villas').onSnapshot(snap => {
  villas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('units').onSnapshot(snap => {
  units = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('repairs').onSnapshot(snap => {
  repairs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});
db.collection('materials').onSnapshot(snap => {
  materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

function addSearchHistory(text) {
  if (!text || text.length < 2) return;
  searchHistory = searchHistory.filter(h => h !== text);
  searchHistory.unshift(text);
  searchHistory = searchHistory.slice(0, 10);
  localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
}

function getUniqueDates() {
  const dates = [...new Set(repairs.map(r => r.receiveDate).filter(Boolean))];
  return dates.sort().reverse();
}

function getUniqueSuppliers() {
  return [...new Set(materials.map(m => m.supplier).filter(Boolean))];
}

function render() {
  const app = document.getElementById('app');
  
  if (currentPage === 'list') {
    if (currentTab === 'as') renderASList(app);
    else if (currentTab === 'villa') renderVillaList(app);
    else if (currentTab === 'material') renderMaterialList(app);
  } else if (currentPage === 'asForm') {
    renderASForm(app);
  } else if (currentPage === 'villaForm') {
    renderVillaForm(app);
  } else if (currentPage === 'unitForm') {
    renderUnitForm(app);
  } else if (currentPage === 'materialForm') {
    renderMaterialForm(app);
  }
}

function renderASList(app) {
  let filtered = repairs.filter(r => filter === 'ì „ì²´' ? true : r.status === filter);
  
  if (selectedDate !== 'all') {
    filtered = filtered.filter(r => r.receiveDate === selectedDate);
  }
  
  if (searchText) {
    const s = searchText.toLowerCase();
    filtered = filtered.filter(r => 
      (r.villaName || '').toLowerCase().includes(s) ||
      (r.unit || '').toLowerCase().includes(s) ||
      (r.description || '').toLowerCase().includes(s) ||
      (r.address || '').toLowerCase().includes(s)
    );
  }
  
  filtered = filtered.sort((a, b) => (b.receiveDate || '').localeCompare(a.receiveDate || ''));
  const dates = getUniqueDates();
  
  app.innerHTML = `
    <div class="header">
      <div>
        <h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1>
        <div class="header-sub">ë¹Œë¼ ${villas.length} | ìˆ˜ë¦¬ ${repairs.length} | ìì¬ ${materials.length}</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" placeholder="ğŸ” ë¹Œë¼ëª…, í˜¸ìˆ˜, ë‚´ìš© ê²€ìƒ‰..." value="${searchText}" oninput="handleSearch(this.value)" onkeypress="if(event.key==='Enter')doSearch()">
      ${searchHistory.length > 0 ? `
        <div class="search-history">
          <div class="search-history-title">ìµœê·¼ ê²€ìƒ‰</div>
          ${searchHistory.map(h => `<span class="search-history-item" onclick="applySearch('${h}')">${h}</span>`).join('')}
        </div>
      ` : ''}
    </div>
    
    <div style="padding: 0 12px;">
      <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 8px;">
        <button class="filter-btn ${filter === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setFilter('ë¯¸ê²°')">ë¯¸ê²° (${repairs.filter(r => r.status === 'ë¯¸ê²°').length})</button>
        <button class="filter-btn ${filter === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setFilter('ì™„ë£Œ')">ì™„ë£Œ (${repairs.filter(r => r.status === 'ì™„ë£Œ').length})</button>
        <button class="filter-btn ${filter === 'ì „ì²´' ? 'active' : ''}" onclick="setFilter('ì „ì²´')">ì „ì²´ (${repairs.length})</button>
        <button class="btn btn-orange btn-sm" style="margin-left: auto;" onclick="goASForm()">+ ì ‘ìˆ˜</button>
      </div>
      
      <div class="date-filter">
        <button class="date-btn ${selectedDate === 'all' ? 'active' : ''}" onclick="setDateFilter('all')">ì „ì²´ë‚ ì§œ</button>
        <button class="date-btn ${selectedDate === today ? 'active' : ''}" onclick="setDateFilter('${today}')">ì˜¤ëŠ˜</button>
        ${dates.slice(0, 7).map(d => `
          <button class="date-btn ${selectedDate === d ? 'active' : ''}" onclick="setDateFilter('${d}')">${d.slice(5)}</button>
        `).join('')}
      </div>
    </div>
    
    ${filtered.length === 0 ? '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>' : filtered.map(r => `
      <div class="list-item ${r.status === 'ì™„ë£Œ' ? 'done' : ''}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <span class="villa-name">${r.villaName || ''}</span>
            <span class="unit-badge">${r.unit || ''}</span>
            <span class="status-badge ${r.status === 'ì™„ë£Œ' ? 'done' : 'pending'}">${r.status || 'ë¯¸ê²°'}</span>
          </div>
          <div class="list-item-date">${r.receiveDate || ''}</div>
        </div>
        ${r.address ? `<div class="list-item-address">ğŸ“ ${r.address}</div>` : ''}
        <div class="list-item-desc">${r.description || ''}</div>
        <div>
          ${r.ownerPhone ? `<a href="tel:${r.ownerPhone}" class="phone-btn owner">ê±´ë¬¼ì£¼ ğŸ“</a><a href="sms:${r.ownerPhone}" class="phone-btn owner">ë¬¸ì</a>` : ''}
          ${r.phone ? `<a href="tel:${r.phone}" class="phone-btn tenant">ì„¸ì…ì ğŸ“</a><a href="sms:${r.phone}" class="phone-btn tenant">ë¬¸ì</a>` : ''}
        </div>
        <div class="action-btns">
          <button class="action-btn btn-${r.status === 'ì™„ë£Œ' ? 'orange' : 'green'}" onclick="toggleStatus('${r.id}')">${r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°ë¡œ' : 'ì™„ë£Œë¡œ'}</button>
          <button class="action-btn btn-blue" onclick="editRepair('${r.id}')">ìˆ˜ì •</button>
          <button class="action-btn btn-red" onclick="deleteRepair('${r.id}')">ì‚­ì œ</button>
        </div>
      </div>
    `).join('')}
  `;
}

function renderASForm(app) {
  const data = editData || { villaName: '', unit: '', description: '', receiveDate: today, status: 'ë¯¸ê²°', phone: '', ownerPhone: '', address: '' };
  const villaNames = [...new Set(villas.map(v => v.name))];
  const selectedVillaData = villas.find(v => v.name === data.villaName);
  const villaUnits = selectedVillaData ? units.filter(u => u.villaId === selectedVillaData.id) : [];
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData ? 'A/S ìˆ˜ì •' : 'A/S ì ‘ìˆ˜'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ì ‘ìˆ˜ì¼</label>
            <input type="date" class="form-input" id="receiveDate" value="${data.receiveDate}">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ *</label>
            ${villaNames.length > 0 ? `
              <div class="villa-grid">
                ${villaNames.map(v => `<button type="button" class="villa-btn ${data.villaName === v ? 'active' : ''}" onclick="selectVillaAS('${v}')">${v}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="villaName" value="${data.villaName}" placeholder="ë¹Œë¼ëª… ì…ë ¥ (ì‹ ê·œì‹œ ìë™ ë“±ë¡)">
          </div>
          
          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="address" value="${data.address || selectedVillaData?.address || ''}" placeholder="ì£¼ì†Œ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            ${villaUnits.length > 0 ? `
              <div class="villa-grid">
                ${villaUnits.map(u => `<button type="button" class="villa-btn ${data.unit === u.unit ? 'active' : ''}" style="background:${data.unit === u.unit ? '#2e7d32' : 'white'}; color:${data.unit === u.unit ? 'white' : '#2e7d32'}" onclick="selectUnitAS('${u.unit}', '${u.phone || ''}')">${u.unit}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="unit" value="${data.unit}" placeholder="í˜¸ìˆ˜ ì…ë ¥">
          </div>
          
          <div class="form-group">
            <label class="form-label">ë‚´ìš© *</label>
            <textarea class="form-input" id="description" placeholder="ìˆ˜ë¦¬ ë‚´ìš©">${data.description}</textarea>
          </div>
          
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">ì„¸ì…ì ì „í™”</label>
              <input type="tel" class="form-input" id="phone" value="${data.phone}" placeholder="010-0000-0000">
            </div>
            <div class="form-group">
              <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
              <input type="tel" class="form-input" id="ownerPhone" value="${data.ownerPhone || selectedVillaData?.ownerPhone || ''}" placeholder="010-0000-0000">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒíƒœ</label>
            <div class="status-select">
              <button type="button" class="status-option pending ${data.status === 'ë¯¸ê²°' ? 'active' : ''}" onclick="setStatusForm('ë¯¸ê²°')">ë¯¸ê²°</button>
              <button type="button" class="status-option done ${data.status === 'ì™„ë£Œ' ? 'active' : ''}" onclick="setStatusForm('ì™„ë£Œ')">ì™„ë£Œ</button>
            </div>
          </div>
          
          <button type="button" class="btn btn-orange btn-block" onclick="saveRepair()" style="margin-top: 10px;">
            ${editData ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì ‘ìˆ˜í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  `;
}

function renderVillaList(app) {
  const villaUnits = selectedVilla ? units.filter(u => u.villaId === selectedVilla.id).sort((a,b) => (parseInt(a.unit)||0) - (parseInt(b.unit)||0)) : [];
  
  app.innerHTML = `
    <div class="header">
      <div><h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1></div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab active" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-weight: 600; color: #00695c;">ë¹Œë¼ ëª©ë¡ (${villas.length})</span>
        <button class="btn btn-orange btn-sm" onclick="goVillaForm()">+ ë¹Œë¼ì¶”ê°€</button>
      </div>
      
      <div class="villa-grid">
        ${villas.map(v => `<button class="villa-btn ${selectedVilla?.id === v.id ? 'active' : ''}" onclick="selectVillaView('${v.id}')">${v.name}</button>`).join('')}
      </div>
    </div>
    
    ${selectedVilla ? `
      <div class="card">
        <div class="card-header">
          <span>${selectedVilla.name}</span>
          <div>
            <button class="btn btn-blue btn-sm" onclick="editVilla('${selectedVilla.id}')" style="margin-right:4px;">ìˆ˜ì •</button>
            <button class="btn btn-green btn-sm" onclick="goUnitForm('${selectedVilla.id}')" style="margin-right:4px;">+í˜¸ìˆ˜</button>
            <button class="btn btn-red btn-sm" onclick="deleteVilla('${selectedVilla.id}')">ì‚­ì œ</button>
          </div>
        </div>
        <div class="villa-info">
          <div>ğŸ“ ${selectedVilla.address || '-'}</div>
          <div style="margin-top:4px;">ğŸ‘¤ ê±´ë¬¼ì£¼ ${selectedVilla.ownerPhone ? `<a href="tel:${selectedVilla.ownerPhone}" style="color:#1565c0;">${selectedVilla.ownerPhone}</a>` : '-'}</div>
        </div>
        <div class="card-body" style="padding-top:0;">
          <table class="unit-table">
            <thead><tr><th style="width:70px;">í˜¸ìˆ˜</th><th>ì„¸ì…ì / ì—°ë½ì²˜</th><th style="width:80px;">ê´€ë¦¬</th></tr></thead>
            <tbody>
              ${villaUnits.length === 0 ? '<tr><td colspan="3" style="text-align:center;color:#999;padding:20px;">ë“±ë¡ëœ í˜¸ìˆ˜ ì—†ìŒ</td></tr>' : villaUnits.map(u => `
                <tr>
                  <td><span class="unit-num">${u.unit}</span></td>
                  <td>
                    <div style="font-weight:600;">${u.tenant || '(ê³µì‹¤)'}</div>
                    ${u.phone ? `<a href="tel:${u.phone}" style="color:#1565c0;font-size:13px;">${u.phone}</a>` : ''}
                    ${u.moveIn ? `<div style="font-size:11px;color:#888;">ì…ì£¼: ${u.moveIn}</div>` : ''}
                  </td>
                  <td>
                    <button class="btn btn-blue btn-sm" onclick="editUnit('${u.id}')" style="margin-bottom:4px;display:block;width:100%;">ìˆ˜ì •</button>
                    <button class="btn btn-red btn-sm" onclick="deleteUnit('${u.id}')" style="display:block;width:100%;">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    ` : ''}
  `;
}

function renderVillaForm(app) {
  const data = editData || { name: '', address: '', ownerPhone: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'ë¹Œë¼ ìˆ˜ì •' : 'ë¹Œë¼ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">ë¹Œë¼ëª… *</label>
            <input type="text" class="form-input" id="villaNameInput" value="${data.name}" placeholder="ë¹Œë¼ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ì£¼ì†Œ</label>
            <input type="text" class="form-input" id="villaAddress" value="${data.address || ''}" placeholder="ì£¼ì†Œ">
          </div>
          <div class="form-group">
            <label class="form-label">ê±´ë¬¼ì£¼ ì „í™”</label>
            <input type="tel" class="form-input" id="villaOwnerPhone" value="${data.ownerPhone || ''}" placeholder="010-0000-0000">
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveVilla()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

function renderUnitForm(app) {
  const data = editData || { unit: '', tenant: '', phone: '', moveIn: '', memo: '' };
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'í˜¸ìˆ˜ ìˆ˜ì •' : 'í˜¸ìˆ˜ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í˜¸ìˆ˜ *</label>
            <input type="text" class="form-input" id="unitNum" value="${data.unit}" placeholder="101">
          </div>
          <div class="form-group">
            <label class="form-label">ì„¸ì…ì</label>
            <input type="text" class="form-input" id="unitTenant" value="${data.tenant || ''}" placeholder="ì„¸ì…ì ì´ë¦„">
          </div>
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input type="tel" class="form-input" id="unitPhone" value="${data.phone || ''}" placeholder="010-0000-0000">
          </div>
          <div class="form-group">
            <label class="form-label">ì…ì£¼ì¼</label>
            <input type="date" class="form-input" id="unitMoveIn" value="${data.moveIn || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <input type="text" class="form-input" id="unitMemo" value="${data.memo || ''}" placeholder="ë©”ëª¨">
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveUnit()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

function renderMaterialList(app) {
  const suppliers = getUniqueSuppliers();
  let filtered = materials;
  
  if (supplierFilter !== 'all') {
    filtered = materials.filter(m => m.supplier === supplierFilter);
  }
  
  const totalProfit = filtered.reduce((sum, m) => sum + (m.profit || 0), 0);
  
  app.innerHTML = `
    <div class="header">
      <div><h1>ğŸ  ë¹Œë¼ ê´€ë¦¬</h1></div>
    </div>
    
    <div class="tabs">
      <button class="tab" onclick="setTab('as')">ğŸ”§ A/S</button>
      <button class="tab" onclick="setTab('villa')">ğŸ¢ ë¹Œë¼</button>
      <button class="tab active" onclick="setTab('material')">ğŸ“¦ ìì¬</button>
    </div>
    
    <div style="padding: 12px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-size: 14px;">ì´ <b>${filtered.length}</b>ê°œ | ì´ìµ <b style="color:#4caf50;">+${totalProfit.toLocaleString()}ì›</b></span>
        <button class="btn btn-orange btn-sm" onclick="goMaterialForm()">+ ì¶”ê°€</button>
      </div>
      
      ${suppliers.length > 0 ? `
        <div style="margin-bottom: 12px;">
          <div style="font-size: 12px; color: #666; margin-bottom: 6px;">êµ¬ì…ì²˜ë³„ ë³´ê¸°</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            <button class="filter-btn ${supplierFilter === 'all' ? 'active' : ''}" onclick="setSupplierFilter('all')">ì „ì²´</button>
            ${suppliers.map(s => `<button class="filter-btn ${supplierFilter === s ? 'active' : ''}" onclick="setSupplierFilter('${s}')">${s}</button>`).join('')}
          </div>
        </div>
      ` : ''}
    </div>
    
    <div class="card" style="margin-top:0;">
      <div class="card-body">
        ${filtered.length === 0 ? '<div class="empty">ë“±ë¡ëœ ìì¬ ì—†ìŒ</div>' : filtered.map(m => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eee;">
            <div style="flex:1;">
              <div style="font-weight:600;">
                ${m.name}
                ${m.supplier ? `<span class="supplier-badge">${m.supplier}</span>` : ''}
              </div>
              <div style="font-size:13px;color:#666;">êµ¬ì… ${(m.price||0).toLocaleString()} â†’ ì²­êµ¬ ${(m.chargePrice||0).toLocaleString()}</div>
              <div style="font-size:13px;color:#4caf50;font-weight:600;">ì´ìµ +${(m.profit||0).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn btn-blue btn-sm" onclick="editMaterial('${m.id}')">ìˆ˜ì •</button>
              <button class="btn btn-red btn-sm" onclick="deleteMaterial('${m.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderMaterialForm(app) {
  const data = editData || { name: '', price: '', chargePrice: '', supplier: '' };
  const suppliers = getUniqueSuppliers();
  
  app.innerHTML = `
    <div class="back-header">
      <button class="back-btn" onclick="goBack()">â†</button>
      <span class="back-title">${editData?.id ? 'ìì¬ ìˆ˜ì •' : 'ìì¬ ì¶”ê°€'}</span>
    </div>
    
    <div style="padding: 16px;">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">í’ˆëª©ëª… *</label>
            <input type="text" class="form-input" id="matName" value="${data.name || ''}" placeholder="í’ˆëª©ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">êµ¬ì…ì²˜</label>
            ${suppliers.length > 0 ? `
              <div class="villa-grid" style="margin-bottom:8px;">
                ${suppliers.map(s => `<button type="button" class="villa-btn ${data.supplier === s ? 'active' : ''}" onclick="document.getElementById('matSupplier').value='${s}'">${s}</button>`).join('')}
              </div>
            ` : ''}
            <input type="text" class="form-input" id="matSupplier" value="${data.supplier || ''}" placeholder="êµ¬ì…ì²˜ ì…ë ¥">
          </div>
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">êµ¬ì…ê°€ *</label>
              <input type="number" class="form-input" id="matPrice" value="${data.price || ''}" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ì²­êµ¬ê°€ *</label>
              <input type="number" class="form-input" id="matChargePrice" value="${data.chargePrice || ''}" placeholder="0">
            </div>
          </div>
          <button type="button" class="btn btn-orange btn-block" onclick="saveMaterial()">${editData?.id ? 'ìˆ˜ì • ì™„ë£Œ' : 'ë“±ë¡í•˜ê¸°'}</button>
        </div>
      </div>
    </div>
  `;
}

// Functions
function setTab(tab) { currentTab = tab; currentPage = 'list'; selectedVilla = null; render(); }
function setFilter(f) { filter = f; render(); }
function setDateFilter(d) { selectedDate = d; render(); }
function setSupplierFilter(s) { supplierFilter = s; render(); }
function goBack() { currentPage = 'list'; editData = null; render(); }
function goASForm() { editData = null; currentPage = 'asForm'; render(); }
function goVillaForm() { editData = null; currentPage = 'villaForm'; render(); }
function goUnitForm(villaId) { editData = { villaId }; currentPage = 'unitForm'; render(); }
function goMaterialForm() { editData = null; currentPage = 'materialForm'; render(); }

function handleSearch(value) { searchText = value; }
function doSearch() { addSearchHistory(searchText); render(); }
function applySearch(text) { searchText = text; addSearchHistory(text); render(); }

let formStatus = 'ë¯¸ê²°';
function setStatusForm(status) {
  formStatus = status;
  document.querySelectorAll('.status-option').forEach(el => {
    el.classList.remove('active');
    if (el.textContent === status) el.classList.add('active');
  });
}

function selectVillaAS(name) {
  document.getElementById('villaName').value = name;
  const villa = villas.find(v => v.name === name);
  if (villa) {
    if (villa.address) document.getElementById('address').value = villa.address;
    if (villa.ownerPhone) document.getElementById('ownerPhone').value = villa.ownerPhone;
  }
  render();
}

function selectUnitAS(unit, phone) {
  document.getElementById('unit').value = unit;
  if (phone) document.getElementById('phone').value = phone;
}

async function saveRepair() {
  const villaName = document.getElementById('villaName').value.trim();
  const unit = document.getElementById('unit').value.trim();
  const description = document.getElementById('description').value.trim();
  const receiveDate = document.getElementById('receiveDate').value;
  const phone = document.getElementById('phone').value.trim();
  const ownerPhone = document.getElementById('ownerPhone').value.trim();
  const address = document.getElementById('address').value.trim();
  const status = formStatus || 'ë¯¸ê²°';
  
  if (!villaName || !unit || !description) {
    alert('ë¹Œë¼, í˜¸ìˆ˜, ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤');
    return;
  }
  
  // ìƒˆ ë¹Œë¼ ìë™ ë“±ë¡
  const existingVilla = villas.find(v => v.name === villaName);
  if (!existingVilla) {
    await db.collection('villas').doc('v_' + Date.now()).set({
      name: villaName,
      address: address,
      ownerPhone: ownerPhone
    });
  }
  
  const data = { villaName, unit, description, receiveDate, phone, ownerPhone, address, status };
  
  try {
    if (editData?.id) {
      await db.collection('repairs').doc(editData.id).update(data);
    } else {
      await db.collection('repairs').doc('r_' + Date.now()).set(data);
    }
    editData = null;
    formStatus = 'ë¯¸ê²°';
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editRepair(id) {
  editData = repairs.find(r => r.id === id);
  formStatus = editData?.status || 'ë¯¸ê²°';
  currentPage = 'asForm';
  render();
}

async function toggleStatus(id) {
  const r = repairs.find(r => r.id === id);
  if (r) await db.collection('repairs').doc(id).update({ status: r.status === 'ì™„ë£Œ' ? 'ë¯¸ê²°' : 'ì™„ë£Œ' });
}

async function deleteRepair(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('repairs').doc(id).delete();
}

function selectVillaView(id) { selectedVilla = villas.find(v => v.id === id); render(); }

async function saveVilla() {
  const name = document.getElementById('villaNameInput').value.trim();
  const address = document.getElementById('villaAddress').value.trim();
  const ownerPhone = document.getElementById('villaOwnerPhone').value.trim();
  
  if (!name) { alert('ë¹Œë¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }
  
  try {
    if (editData?.id) {
      await db.collection('villas').doc(editData.id).update({ name, address, ownerPhone });
    } else {
      await db.collection('villas').doc('v_' + Date.now()).set({ name, address, ownerPhone });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editVilla(id) { editData = villas.find(v => v.id === id); currentPage = 'villaForm'; render(); }

async function deleteVilla(id) {
  if (confirm('ë¹Œë¼ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
    await db.collection('villas').doc(id).delete();
    for (const u of units.filter(u => u.villaId === id)) {
      await db.collection('units').doc(u.id).delete();
    }
    selectedVilla = null;
    render();
  }
}

async function saveUnit() {
  const unit = document.getElementById('unitNum').value.trim();
  const tenant = document.getElementById('unitTenant').value.trim();
  const phone = document.getElementById('unitPhone').value.trim();
  const moveIn = document.getElementById('unitMoveIn').value;
  const memo = document.getElementById('unitMemo').value.trim();
  
  if (!unit) { alert('í˜¸ìˆ˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }
  
  try {
    if (editData?.id) {
      await db.collection('units').doc(editData.id).update({ unit, tenant, phone, moveIn, memo });
    } else {
      await db.collection('units').doc('u_' + Date.now()).set({ unit, tenant, phone, moveIn, memo, villaId: editData.villaId });
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editUnit(id) {
  const u = units.find(u => u.id === id);
  editData = { ...u };
  currentPage = 'unitForm';
  render();
}

async function deleteUnit(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('units').doc(id).delete();
}

async function saveMaterial() {
  const name = document.getElementById('matName').value.trim();
  const supplier = document.getElementById('matSupplier').value.trim();
  const price = parseInt(document.getElementById('matPrice').value) || 0;
  const chargePrice = parseInt(document.getElementById('matChargePrice').value) || 0;
  
  if (!name || !price || !chargePrice) { alert('í’ˆëª©ëª…, êµ¬ì…ê°€, ì²­êµ¬ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  
  try {
    const data = { name, supplier, price, chargePrice, profit: chargePrice - price };
    if (editData?.id) {
      await db.collection('materials').doc(editData.id).update(data);
    } else {
      await db.collection('materials').doc('m_' + Date.now()).set(data);
    }
    editData = null;
    currentPage = 'list';
    render();
  } catch (e) {
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}

function editMaterial(id) {
  editData = materials.find(m => m.id === id);
  currentPage = 'materialForm';
  render();
}

async function deleteMaterial(id) {
  if (confirm('ì‚­ì œí• ê¹Œìš”?')) await db.collection('materials').doc(id).delete();
}

setTimeout(render, 1000);
</script>

</body>
</html>
