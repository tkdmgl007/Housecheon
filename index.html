<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ë¹Œë¼ê´€ë¦¬ v5</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,sans-serif;background:#e0f7fa;min-height:100vh}.header{background:linear-gradient(90deg,#00695c,#00897b);color:#fff;padding:14px 16px;position:sticky;top:0;z-index:100}.tabs{display:flex;background:#004d40}.tab{flex:1;padding:12px;text-align:center;color:#fff;border:none;background:0 0;font-size:12px;cursor:pointer;border-bottom:3px solid transparent}.tab.active{background:#00796b;border-bottom-color:#ffb300}.card{background:#fff;border-radius:10px;margin:12px;box-shadow:0 2px 8px rgba(0,0,0,.1)}.card-header{background:#37474f;color:#fff;padding:12px;font-size:15px;display:flex;justify-content:space-between}.card-body{padding:14px}.form-group{margin-bottom:14px}.form-label{font-size:13px;color:#666;margin-bottom:6px;display:block}.form-input,.form-select{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px}textarea.form-input{min-height:80px}.btn{padding:12px 18px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}.btn-orange{background:#ff9800;color:#fff}.btn-green{background:#4caf50;color:#fff}.btn-blue{background:#2196f3;color:#fff}.btn-red{background:#f44336;color:#fff}.btn-purple{background:#9c27b0;color:#fff}.btn-block{width:100%}.btn-sm{padding:8px 12px;font-size:13px}.filter-btn{padding:8px 14px;border-radius:20px;border:none;font-size:13px;font-weight:600;margin:4px;cursor:pointer}.filter-btn.active{background:#00695c;color:#fff}.filter-btn:not(.active){background:#fff;color:#00695c}.list-item{background:#fff;border-radius:10px;padding:14px;margin:10px 12px;border-left:4px solid #ff9800}.list-item.done{border-left-color:#4caf50}.villa-name{font-weight:700;font-size:16px}.unit-badge{background:#1565c0;color:#fff;padding:4px 10px;border-radius:6px;font-size:13px;margin-left:8px}.status-badge{padding:4px 10px;border-radius:12px;font-size:12px}.status-badge.pending{background:#fff3e0;color:#e65100}.status-badge.done{background:#e8f5e9;color:#2e7d32}.time-badge{background:#e3f2fd;color:#1565c0;padding:3px 8px;border-radius:4px;font-size:11px;margin-left:6px}.list-item-desc{color:#333;font-size:14px;margin:8px 0}.phone-btn{display:inline-block;padding:6px 12px;border-radius:6px;font-size:12px;text-decoration:none;margin:4px}.phone-btn.owner{background:#fff3e0;color:#e65100}.phone-btn.tenant{background:#e8f5e9;color:#2e7d32}.action-btns{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}.action-btn{padding:8px 12px;border-radius:6px;border:none;font-size:12px;cursor:pointer}.search-box{background:#fff;margin:12px;border-radius:10px;padding:12px}.search-input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px}.back-header{background:#00695c;color:#fff;padding:14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100}.back-btn{background:0 0;border:none;color:#fff;font-size:24px;cursor:pointer}.villa-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}.villa-btn{padding:10px 14px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer;background:#fff;color:#00695c}.villa-btn.active{background:#00695c;color:#fff}.row-2{display:flex;gap:12px}.row-2>div{flex:1}.status-select{display:flex;gap:10px}.status-option{flex:1;padding:12px;border-radius:8px;border:2px solid #ddd;font-size:14px;cursor:pointer;text-align:center;background:#fff}.status-option.active{border-color:#00695c;background:#e0f2f1}.empty{text-align:center;padding:40px;color:#999}.date-divider{background:#00695c;color:#fff;padding:8px 16px;margin:16px 12px 8px;border-radius:8px;font-size:14px;font-weight:600}.supplier-badge{background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:6px}.unit-num{background:#e3f2fd;color:#1565c0;padding:6px 12px;border-radius:6px;font-weight:700}.unit-num.empty{background:#ffebee;color:#c62828}.paid-badge{background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:4px;font-size:11px}.unpaid-badge{background:#ffebee;color:#c62828;padding:2px 8px;border-radius:4px;font-size:11px}.stock-card{background:#fff;border-radius:8px;padding:12px;display:inline-block;margin:4px}.stock-name{font-size:12px;color:#666}.stock-qty{font-size:20px;font-weight:700;color:#1565c0}.tx-item{background:#fff;padding:12px;border-radius:8px;margin-bottom:8px}.tx-type{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600}.tx-type.buy{background:#e3f2fd;color:#1565c0}.tx-type.sell{background:#fff3e0;color:#e65100}.mic-btn{background:#f44336;color:#fff;border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer}.mic-btn.recording{animation:pulse 1s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}.quick-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px}.quick-modal-content{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto}.quick-textarea{width:100%;min-height:80px;padding:14px;border:2px solid #ddd;border-radius:10px;font-size:16px;resize:none}.template-btn{background:#e1bee7;color:#7b1fa2;padding:8px 12px;border:none;border-radius:8px;font-size:13px;margin:4px;cursor:pointer}.report-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.report-total{background:#e8f5e9;padding:12px;border-radius:8px;margin-top:12px;font-weight:600}.photo-preview{width:60px;height:60px;object-fit:cover;border-radius:8px;margin:4px;cursor:pointer}.photo-grid{display:flex;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
<div id="app"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh"><div style="font-size:48px">ğŸ </div><div style="color:#00695c;margin-top:16px">ì—°ê²° ì¤‘...</div></div></div>
<div id="quickModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeQuickModal()"><div class="quick-modal-content"><div style="font-size:18px;font-weight:700;margin-bottom:16px">âš¡ ë¹ ë¥¸ ì ‘ìˆ˜</div><textarea id="quickInput" class="quick-textarea" placeholder="ì˜ˆ: ì¸í•˜ìš°ìŠ¤ 102 ì˜¤ì „ ìˆ˜ì „êµì²´"></textarea><div style="display:flex;gap:10px;margin-top:12px"><button onclick="startVoice('q')" class="mic-btn" id="micBtn">ğŸ¤</button><div style="flex:1"><button onclick="submitQuick()" class="btn btn-orange btn-block">ì ‘ìˆ˜</button></div></div><div style="margin-top:12px"><div style="font-size:12px;color:#666;margin-bottom:8px">ğŸ“‹ í…œí”Œë¦¿</div><div id="tplBtns"></div></div><div style="margin-top:16px;text-align:center"><button onclick="closeQuickModal()" style="background:0 0;border:none;color:#999">ë‹«ê¸°</button></div></div></div>
<div id="quickBuyModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeQuickBuyModal()"><div class="quick-modal-content"><div style="font-size:18px;font-weight:700;margin-bottom:16px">ğŸ›’ ë¹ ë¥¸ êµ¬ë§¤</div><textarea id="quickBuyInput" class="quick-textarea" placeholder="ì¿ íŒ¡ ë¬¸ê³ ë¦¬ 2ê°œ 1100ì›"></textarea><div style="display:flex;gap:10px;margin-top:12px"><button onclick="startVoice('b')" class="mic-btn" id="micBtnB">ğŸ¤</button><div style="flex:1"><button onclick="submitQuickBuy()" class="btn btn-blue btn-block">ë“±ë¡</button></div></div><div style="margin-top:16px;text-align:center"><button onclick="closeQuickBuyModal()" style="background:0 0;border:none;color:#999">ë‹«ê¸°</button></div></div></div>
<div id="completeModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeCompleteModal()"><div class="quick-modal-content"><div style="font-size:18px;font-weight:700;margin-bottom:16px">âœ… A/S ì™„ë£Œ</div><div id="cInfo" style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px"></div><div class="form-group"><label class="form-label">ğŸ“ ë©”ëª¨</label><textarea id="cMemo" class="quick-textarea"></textarea></div><div class="form-group"><label class="form-label">ğŸ“¦ ìì¬</label><div id="matSel" class="villa-grid"></div><div id="selMats" style="margin-top:8px"></div></div><div class="form-group"><label class="form-label">ğŸ’° ì²­êµ¬</label><div class="status-select"><button class="status-option active" onclick="setCharge('ê±´ë¬¼ì£¼')">ê±´ë¬¼ì£¼</button><button class="status-option" onclick="setCharge('ì„¸ì…ì')">ì„¸ì…ì</button><button class="status-option" onclick="setCharge('ì•ˆí•¨')">ì•ˆí•¨</button></div></div><div class="form-group"><label class="form-label">ğŸ“· ì‚¬ì§„</label><input type="file" id="photoIn" accept="image/*" multiple onchange="handlePhotos(this.files)" style="display:none"><button onclick="document.getElementById('photoIn').click()" class="btn btn-sm" style="background:#9e9e9e;color:#fff">ì„ íƒ</button><div id="photoPv" class="photo-grid"></div></div><button onclick="submitComplete()" class="btn btn-green btn-block">ì™„ë£Œ</button><div style="margin-top:12px;text-align:center"><button onclick="closeCompleteModal()" style="background:0 0;border:none;color:#999">ì·¨ì†Œ</button></div></div></div>
<div id="reportModal" style="display:none" class="quick-modal" onclick="if(event.target===this)closeReportModal()"><div class="quick-modal-content" style="max-width:500px"><div style="font-size:18px;font-weight:700;margin-bottom:16px">ğŸ“Š ì›”ë³„ ë¦¬í¬íŠ¸</div><div class="row-2" style="margin-bottom:16px"><div><select id="rptY" class="form-select" onchange="genReport()"></select></div><div><select id="rptM" class="form-select" onchange="genReport()"></select></div></div><div id="rptC"></div><div style="margin-top:16px;text-align:center"><button onclick="closeReportModal()" style="background:0 0;border:none;color:#999">ë‹«ê¸°</button></div></div></div>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyBrMcbN2Iv3hjBW0uQx7_gSXAWcwTTSgGI",authDomain:"villa-management-4af75.firebaseapp.com",projectId:"villa-management-4af75",storageBucket:"villa-management-4af75.firebasestorage.app",messagingSenderId:"994416353525",appId:"1:994416353525:web:3bd200acc5d68f6df065bc"});
const db=firebase.firestore(),storage=firebase.storage();
let pg='list',tab='as',flt='ë¯¸ê²°',selD='all',villas=[],units=[],repairs=[],mats=[],txs=[],moveH=[],ed=null,selV=null,selU=null,srch='',supF='all',txF='all',fmSt='ë¯¸ê²°';
let compId=null,selM=[],photos=[],chrg='ê±´ë¬¼ì£¼';
const tpl=[{n:'ìˆ˜ì „êµì²´',i:['ê²¸ìš©ìˆ˜ì „'],p:25000},{n:'ë³´ì¼ëŸ¬AS',i:[],p:30000},{n:'ë³€ê¸°ìˆ˜ë¦¬',i:['ë³€ê¸°ë¶€ì†'],p:20000},{n:'ë°°ìˆ˜ë§‰í˜',i:[],p:15000}];
const today=new Date(Date.now()+9*60*60*1000).toISOString().split('T')[0];
db.collection('villas').onSnapshot(s=>{villas=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'));render()});
db.collection('units').onSnapshot(s=>{units=s.docs.map(d=>({id:d.id,...d.data()}));render()});
db.collection('repairs').onSnapshot(s=>{repairs=s.docs.map(d=>({id:d.id,...d.data()}));render()});
db.collection('materials').onSnapshot(s=>{mats=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.name||'').localeCompare(b.name||'','ko'));render()});
db.collection('transactions').onSnapshot(s=>{txs=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.date||'').localeCompare(a.date||''));render()});
db.collection('moveOutHistory').onSnapshot(s=>{moveH=s.docs.map(d=>({id:d.id,...d.data()}));render()});

function getSup(){return[...new Set(mats.map(m=>m.supplier).filter(Boolean))].sort()}
async function updMatP(n,s,p){const m=mats.find(m=>m.name===n);if(m)await db.collection('materials').doc(m.id).update({price:p,supplier:s||m.supplier});else await db.collection('materials').doc('m_'+Date.now()).set({name:n,supplier:s||'',price:p,chargePrice:Math.round(p*1.5),unitEa:''})}
function openMap(a){if(a)window.open('https://map.naver.com/v5/search/'+encodeURIComponent(a),'_blank')}
function startVoice(t){if(!('webkitSpeechRecognition' in window))return alert('ìŒì„± ë¯¸ì§€ì›');const SR=window.webkitSpeechRecognition,r=new SR();r.lang='ko-KR';const bid=t==='b'?'micBtnB':'micBtn',iid=t==='b'?'quickBuyInput':'quickInput',b=document.getElementById(bid);b.classList.add('recording');b.textContent='ğŸ”´';r.onresult=e=>{document.getElementById(iid).value+=e.results[0][0].transcript};r.onend=()=>{b.classList.remove('recording');b.textContent='ğŸ¤'};r.onerror=r.onend;r.start()}
function parseQB(t){const r=[];t.split('\n').filter(l=>l.trim()).forEach(l=>{let m=l.match(/([ê°€-í£a-zA-Z]+)\s+([ê°€-í£a-zA-Z0-9]+)\s*(\d+)\s*ê°œ?\s*(\d+)/);if(m)r.push({sup:m[1],item:m[2],qty:+m[3],price:+m[4]});else{m=l.match(/([ê°€-í£a-zA-Z0-9]+)\s*(\d+)\s*ê°œ?\s*(\d+)/);if(m)r.push({sup:'',item:m[1],qty:+m[2],price:+m[3]})}});return r}
async function submitQuickBuy(){const t=document.getElementById('quickBuyInput').value.trim();if(!t)return alert('ì…ë ¥');const its=parseQB(t);if(!its.length)return alert('ì¸ì‹ì‹¤íŒ¨');if(!confirm(its.map((i,n)=>(n+1)+'. '+i.sup+' '+i.item+' '+i.qty+'ê°œ @'+i.price).join('\n')+'\n\në“±ë¡?'))return;for(const i of its){await db.collection('transactions').doc('tx_'+Date.now()+'_'+Math.random().toString(36).substr(2,4)).set({type:'buy',date:today,itemName:i.item,supplier:i.sup,qty:i.qty,unitPrice:i.price,totalPrice:i.qty*i.price});await updMatP(i.item,i.sup,i.price)}alert('âœ… '+its.length+'ê±´');document.getElementById('quickBuyInput').value='';closeQuickBuyModal()}
function openCompleteModal(id){compId=id;const r=repairs.find(r=>r.id===id);if(!r)return;document.getElementById('cInfo').innerHTML='<b>'+r.villaName+' '+r.unit+'í˜¸</b><br>'+r.description;document.getElementById('cMemo').value=r.workMemo||'';document.getElementById('matSel').innerHTML=mats.map(m=>'<button class="villa-btn" onclick="togMat(\''+m.name+'\','+m.chargePrice+')">'+m.name+'</button>').join('')+'<div style="width:100%;margin-top:8px;border-top:1px solid #ddd;padding-top:8px">'+tpl.map(t=>'<button class="template-btn" onclick="applyTpl(\''+t.n+'\')">'+t.n+'</button>').join('')+'</div>';selM=[];photos=[];chrg='ê±´ë¬¼ì£¼';document.getElementById('selMats').innerHTML='';document.getElementById('photoPv').innerHTML='';document.getElementById('completeModal').style.display='flex'}
function closeCompleteModal(){document.getElementById('completeModal').style.display='none';compId=null}
function togMat(n,p){const i=selM.findIndex(m=>m.n===n);if(i>=0)selM.splice(i,1);else{const q=prompt(n+' ìˆ˜ëŸ‰?','1');if(q&&+q>0)selM.push({n,q:+q,p})}rendSelM()}
function applyTpl(n){const t=tpl.find(t=>t.n===n);if(!t)return;t.i.forEach(i=>{const m=mats.find(m=>m.name===i);if(m&&!selM.find(s=>s.n===i))selM.push({n:i,q:1,p:m.chargePrice})});if(t.p>0){const m=document.getElementById('cMemo');if(!m.value.includes('ì‘ì—…ë¹„'))m.value+=(m.value?'\n':'')+'ì‘ì—…ë¹„ '+t.p.toLocaleString()+'ì›'}rendSelM()}
function rendSelM(){const t=selM.reduce((s,m)=>s+m.q*m.p,0);document.getElementById('selMats').innerHTML=selM.length?selM.map(m=>'<span style="background:#e8f5e9;padding:4px 8px;border-radius:4px;margin:2px;font-size:13px">'+m.n+' x'+m.q+' <span onclick="remMat(\''+m.n+'\')" style="color:#c62828;cursor:pointer">âœ•</span></span>').join('')+'<div style="margin-top:8px;font-weight:600">í•©ê³„: '+t.toLocaleString()+'ì›</div>':''}
function remMat(n){selM=selM.filter(m=>m.n!==n);rendSelM()}
function setCharge(c){chrg=c;document.querySelectorAll('#completeModal .status-option').forEach(b=>b.classList.toggle('active',b.textContent===c))}
function handlePhotos(files){const pv=document.getElementById('photoPv');[...files].forEach(f=>{const r=new FileReader();r.onload=e=>{photos.push({file:f,url:e.target.result});pv.innerHTML+='<img src="'+e.target.result+'" class="photo-preview">'};r.readAsDataURL(f)})}
async function uploadPhotos(id){const urls=[];for(let i=0;i<photos.length;i++){const ref=storage.ref().child('repairs/'+id+'/'+Date.now()+'_'+i+'.jpg');await ref.put(photos[i].file);urls.push(await ref.getDownloadURL())}return urls}
async function submitComplete(){if(!compId)return;const r=repairs.find(r=>r.id===compId);if(!r)return;const memo=document.getElementById('cMemo').value.trim();let pUrls=[];if(photos.length)try{pUrls=await uploadPhotos(compId)}catch(e){}await db.collection('repairs').doc(compId).update({status:'ì™„ë£Œ',workMemo:memo,photos:pUrls,completedAt:today});if(selM.length&&chrg!=='ì•ˆí•¨')for(const m of selM)await db.collection('transactions').doc('tx_'+Date.now()+'_'+Math.random().toString(36).substr(2,4)).set({type:'sell',date:today,itemName:m.n,villaName:r.villaName,unit:r.unit,qty:m.q,chargeAmount:m.q*m.p,chargeTarget:chrg,isPaid:false});alert('âœ…');closeCompleteModal()}
function openReportModal(){const y=document.getElementById('rptY'),m=document.getElementById('rptM'),cy=new Date().getFullYear();y.innerHTML='';for(let i=cy;i>=cy-2;i--)y.innerHTML+='<option value="'+i+'">'+i+'ë…„</option>';m.innerHTML='';for(let i=1;i<=12;i++)m.innerHTML+='<option value="'+i+'" '+(i===new Date().getMonth()+1?'selected':'')+'>'+i+'ì›”</option>';document.getElementById('reportModal').style.display='flex';genReport()}
function closeReportModal(){document.getElementById('reportModal').style.display='none'}
function genReport(){const y=document.getElementById('rptY').value,m=String(document.getElementById('rptM').value).padStart(2,'0'),p=y+'-'+m,vs={};repairs.filter(r=>r.receiveDate?.startsWith(p)).forEach(r=>{if(!vs[r.villaName])vs[r.villaName]={rep:0,done:0,chg:0,unp:0};vs[r.villaName].rep++;if(r.status==='ì™„ë£Œ')vs[r.villaName].done++});txs.filter(t=>t.type==='sell'&&t.date?.startsWith(p)).forEach(t=>{if(!vs[t.villaName])vs[t.villaName]={rep:0,done:0,chg:0,unp:0};vs[t.villaName].chg+=(t.chargeAmount||0);if(!t.isPaid)vs[t.villaName].unp+=(t.chargeAmount||0)});let h='',tr=0,tc=0,tu=0;Object.keys(vs).sort().forEach(v=>{const s=vs[v];tr+=s.rep;tc+=s.chg;tu+=s.unp;h+='<div class="card"><div style="font-weight:700;color:#00695c;padding:12px">'+v+'</div><div class="card-body"><div class="report-row"><span>A/S</span><span>'+s.rep+'ê±´(ì™„ë£Œ'+s.done+')</span></div><div class="report-row"><span>ì²­êµ¬</span><span>'+s.chg.toLocaleString()+'ì›</span></div>'+(s.unp>0?'<div class="report-row" style="color:#c62828"><span>ë¯¸ìˆ˜ê¸ˆ</span><span>'+s.unp.toLocaleString()+'ì›</span></div>':'')+'</div></div>'});h+='<div class="report-total">ğŸ“Š '+y+'ë…„ '+parseInt(m)+'ì›”: A/S '+tr+'ê±´ | ì²­êµ¬ '+tc.toLocaleString()+'ì› | ë¯¸ìˆ˜ê¸ˆ '+tu.toLocaleString()+'ì›</div>';document.getElementById('rptC').innerHTML=h||'<div class="empty">ì—†ìŒ</div>'}
function render(){const app=document.getElementById('app');if(pg==='list'){if(tab==='as')renderAS(app);else if(tab==='villa')renderVilla(app);else if(tab==='material')renderMat(app);else if(tab==='transaction')renderTx(app)}else if(pg==='asForm')renderASForm(app);else if(pg==='villaForm')renderVillaForm(app);else if(pg==='unitForm')renderUnitForm(app);else if(pg==='unitDetail')renderUnitDetail(app);else if(pg==='matForm')renderMatForm(app);else if(pg==='txBuyForm')renderTxBuyForm(app);else if(pg==='txSellForm')renderTxSellForm(app);const tb=document.getElementById('tplBtns');if(tb)tb.innerHTML=tpl.map(t=>'<button class="template-btn" onclick="document.getElementById(\'quickInput\').value+=\''+t.n+' \'">'+t.n+'</button>').join('')}
function renderAS(app){let f=repairs.filter(r=>flt==='ì „ì²´'||r.status===flt);if(selD!=='all')f=f.filter(r=>r.receiveDate===selD);if(srch){const s=srch.toLowerCase();f=f.filter(r=>(r.villaName||'').toLowerCase().includes(s)||(r.unit||'').toLowerCase().includes(s)||(r.description||'').toLowerCase().includes(s)||(r.workMemo||'').toLowerCase().includes(s))}f.sort((a,b)=>(b.receiveDate||'').localeCompare(a.receiveDate||''));const dates=[...new Set(repairs.map(r=>r.receiveDate).filter(Boolean))].sort().reverse(),tc=repairs.filter(r=>r.receiveDate===today&&r.status==='ë¯¸ê²°').length;let grp={};f.forEach(r=>{const d=r.receiveDate||'?';if(!grp[d])grp[d]=[];grp[d].push(r)});let list='';Object.keys(grp).sort().reverse().forEach(d=>{list+='<div class="date-divider">ğŸ“… '+d+(d===today?' (ì˜¤ëŠ˜)':'')+'</div>';grp[d].forEach(r=>{const hp=r.photos?.length>0;list+='<div class="list-item '+(r.status==='ì™„ë£Œ'?'done':'')+'"><div><span class="villa-name">'+r.villaName+'</span><span class="unit-badge">'+r.unit+'</span><span class="status-badge '+(r.status==='ì™„ë£Œ'?'done':'pending')+'">'+r.status+'</span>'+(r.visitTime?'<span class="time-badge">â°'+r.visitTime+'</span>':'')+(hp?' ğŸ“·':'')+'</div>'+(r.address?'<div style="font-size:12px;color:#1565c0;margin-top:4px;cursor:pointer" onclick="openMap(\''+r.address+'\')">ğŸ“ '+r.address+'</div>':'')+'<div class="list-item-desc">'+r.description+'</div>'+(r.workMemo?'<div style="background:#fff3e0;padding:8px;border-radius:6px;margin-top:6px;font-size:13px">ğŸ“ '+r.workMemo+'</div>':'')+(hp?'<div class="photo-grid">'+r.photos.map(p=>'<img src="'+p+'" class="photo-preview" onclick="window.open(\''+p+'\')">').join('')+'</div>':'')+'<div>'+(r.ownerPhone?'<a href="tel:'+r.ownerPhone+'" class="phone-btn owner">ê±´ë¬¼ì£¼ğŸ“</a>':'')+(r.phone?'<a href="tel:'+r.phone+'" class="phone-btn tenant">ì„¸ì…ìğŸ“</a>':'')+'</div><div class="action-btns">'+(r.status==='ë¯¸ê²°'?'<button class="action-btn btn-green" onclick="openCompleteModal(\''+r.id+'\')">âœ…ì™„ë£Œ</button>':'<button class="action-btn btn-orange" onclick="togSt(\''+r.id+'\')">ë¯¸ê²°</button>')+'<button class="action-btn btn-blue" onclick="editRep(\''+r.id+'\')">ìˆ˜ì •</button><button class="action-btn btn-red" onclick="delRep(\''+r.id+'\')">ì‚­ì œ</button></div></div>'})});app.innerHTML='<div class="header"><div style="display:flex;justify-content:space-between;width:100%"><div><h1 style="font-size:20px">ğŸ  ë¹Œë¼ê´€ë¦¬</h1><div style="font-size:11px;opacity:.9;margin-top:2px">ë¹Œë¼ '+villas.length+' | ìˆ˜ë¦¬ '+repairs.length+' | ìì¬ '+mats.length+'</div></div><div style="display:flex;gap:8px"><button onclick="openQuickModal()" style="background:#ff9800;border:none;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600">âš¡ì ‘ìˆ˜</button><button onclick="openReportModal()" style="background:#9c27b0;border:none;color:#fff;padding:8px 12px;border-radius:8px">ğŸ“Š</button></div></div></div><div class="tabs"><button class="tab active" onclick="setTab(\'as\')">ğŸ”§A/S</button><button class="tab" onclick="setTab(\'villa\')">ğŸ¢ë¹Œë¼</button><button class="tab" onclick="setTab(\'material\')">ğŸ“¦ìì¬</button><button class="tab" onclick="setTab(\'transaction\')">ğŸ’°ê±°ë˜</button></div>'+(tc>0?'<button onclick="openTodayMap()" style="background:#4caf50;color:#fff;padding:12px;border:none;border-radius:8px;margin:12px;width:calc(100% - 24px);font-weight:600">ğŸ—ºï¸ ì˜¤ëŠ˜ ('+tc+'ê±´)</button>':'')+'<div class="search-box"><input class="search-input" placeholder="ğŸ” ê²€ìƒ‰..." value="'+srch+'" oninput="srch=this.value" onkeypress="if(event.key===\'Enter\')render()"></div><div style="padding:0 12px"><div style="display:flex;flex-wrap:wrap;align-items:center;margin-bottom:8px"><button class="filter-btn '+(flt==='ë¯¸ê²°'?'active':'')+'" onclick="setFlt(\'ë¯¸ê²°\')">ë¯¸ê²° ('+repairs.filter(r=>r.status==='ë¯¸ê²°').length+')</button><button class="filter-btn '+(flt==='ì™„ë£Œ'?'active':'')+'" onclick="setFlt(\'ì™„ë£Œ\')">ì™„ë£Œ</button><button class="filter-btn '+(flt==='ì „ì²´'?'active':'')+'" onclick="setFlt(\'ì „ì²´\')">ì „ì²´</button><button class="btn btn-orange btn-sm" style="margin-left:auto" onclick="goASForm()">+ ì ‘ìˆ˜</button></div><div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px"><button class="filter-btn '+(selD===today?'active':'')+'" onclick="setSelD(\''+today+'\')">ì˜¤ëŠ˜</button><button class="filter-btn '+(selD==='all'?'active':'')+'" onclick="setSelD(\'all\')">ì „ì²´</button>'+dates.filter(d=>d!==today).slice(0,5).map(d=>'<button class="filter-btn '+(selD===d?'active':'')+'" onclick="setSelD(\''+d+'\')">'+d.slice(5)+'</button>').join('')+'</div></div>'+(f.length?list:'<div class="empty">ì—†ìŒ</div>')}
function renderTx(app){const stock={};txs.forEach(t=>{if(!stock[t.itemName])stock[t.itemName]=0;stock[t.itemName]+=t.type==='buy'?(t.qty||0):-(t.qty||0)});let f=[...txs];if(txF==='buy')f=f.filter(t=>t.type==='buy');else if(txF==='sell')f=f.filter(t=>t.type==='sell');else if(txF==='unpaid')f=f.filter(t=>t.type==='sell'&&!t.isPaid);const unpaid=txs.filter(t=>t.type==='sell'&&!t.isPaid).reduce((s,t)=>s+(t.chargeAmount||0),0);let grp={};f.forEach(t=>{const d=t.date||'?';if(!grp[d])grp[d]=[];grp[d].push(t)});let list='';Object.keys(grp).sort().reverse().forEach(d=>{list+='<div class="date-divider">ğŸ“… '+d+(d===today?' (ì˜¤ëŠ˜)':'')+'</div>';grp[d].forEach(t=>{list+='<div class="tx-item"><div><span class="tx-type '+t.type+'">'+(t.type==='buy'?'êµ¬ë§¤':'íŒë§¤')+'</span><span style="font-weight:600;margin-left:8px">'+t.itemName+'</span> x'+t.qty+'</div>'+(t.type==='buy'?'<div style="font-size:13px;color:#666;margin-top:6px">'+(t.supplier||'')+' | '+(t.unitPrice||0).toLocaleString()+'ì› x '+t.qty+' = <b>'+(t.totalPrice||0).toLocaleString()+'ì›</b></div>':'<div style="font-size:13px;color:#666;margin-top:6px">'+t.villaName+' '+t.unit+'í˜¸ | '+t.chargeTarget+' | <b>'+(t.chargeAmount||0).toLocaleString()+'ì›</b> <span class="'+(t.isPaid?'paid-badge':'unpaid-badge')+'">'+(t.isPaid?'ë‚©ë¶€':'ë¯¸ë‚©')+'</span>'+(!t.isPaid?' <button class="btn btn-sm btn-green" style="padding:4px 8px" onclick="markPaid(\''+t.id+'\')">ë‚©ë¶€</button>':'')+'</div>')+'<div style="margin-top:8px"><button class="btn btn-sm btn-blue" onclick="editTx(\''+t.id+'\')">ìˆ˜ì •</button> <button class="btn btn-sm btn-red" onclick="delTx(\''+t.id+'\')">ì‚­ì œ</button></div></div>'})});app.innerHTML='<div class="header"><div style="display:flex;justify-content:space-between;width:100%"><div><h1 style="font-size:20px">ğŸ  ë¹Œë¼ê´€ë¦¬</h1></div><div style="display:flex;gap:8px"><button onclick="openQuickBuyModal()" style="background:#2196f3;border:none;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600">ğŸ›’ë¹ ë¥¸êµ¬ë§¤</button><button onclick="openReportModal()" style="background:#9c27b0;border:none;color:#fff;padding:8px 12px;border-radius:8px">ğŸ“Š</button></div></div></div><div class="tabs"><button class="tab" onclick="setTab(\'as\')">ğŸ”§A/S</button><button class="tab" onclick="setTab(\'villa\')">ğŸ¢ë¹Œë¼</button><button class="tab" onclick="setTab(\'material\')">ğŸ“¦ìì¬</button><button class="tab active" onclick="setTab(\'transaction\')">ğŸ’°ê±°ë˜</button></div><div style="padding:12px"><div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-blue btn-sm" onclick="goTxBuyForm()">+ êµ¬ë§¤</button><button class="btn btn-orange btn-sm" onclick="goTxSellForm()">+ íŒë§¤</button></div>'+(unpaid>0?'<div style="background:#ffebee;padding:12px;border-radius:8px;margin-bottom:12px;color:#c62828;font-weight:600">ğŸ’¸ ë¯¸ìˆ˜ê¸ˆ: '+unpaid.toLocaleString()+'ì›</div>':'')+'<div style="font-weight:600;margin-bottom:8px">ğŸ“¦ ì¬ê³ </div><div style="margin-bottom:16px">'+Object.entries(stock).filter(([k,v])=>v>0).map(([n,q])=>'<div class="stock-card"><div class="stock-name">'+n+'</div><div class="stock-qty">'+q+'ê°œ</div></div>').join('')+'</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px"><button class="filter-btn '+(txF==='all'?'active':'')+'" onclick="txF=\'all\';render()">ì „ì²´</button><button class="filter-btn '+(txF==='buy'?'active':'')+'" onclick="txF=\'buy\';render()">êµ¬ë§¤</button><button class="filter-btn '+(txF==='sell'?'active':'')+'" onclick="txF=\'sell\';render()">íŒë§¤</button><button class="filter-btn '+(txF==='unpaid'?'active':'')+'" onclick="txF=\'unpaid\';render()">ë¯¸ë‚©</button></div></div><div style="padding:0 12px">'+(f.length?list:'<div class="empty">ì—†ìŒ</div>')+'</div>'}
function renderVilla(app){let fv=villas;if(srch)fv=villas.filter(v=>(v.name||'').toLowerCase().includes(srch.toLowerCase()));const vu=selV?units.filter(u=>u.villaId===selV.id).sort((a,b)=>(+a.unit||0)-(+b.unit||0)):[];app.innerHTML='<div class="header"><div style="display:flex;justify-content:space-between;width:100%"><div><h1 style="font-size:20px">ğŸ  ë¹Œë¼ê´€ë¦¬</h1></div><button onclick="openQuickModal()" style="background:#ff9800;border:none;color:#fff;padding:8px 12px;border-radius:8px">âš¡</button></div></div><div class="tabs"><button class="tab" onclick="setTab(\'as\')">ğŸ”§A/S</button><button class="tab active" onclick="setTab(\'villa\')">ğŸ¢ë¹Œë¼</button><button class="tab" onclick="setTab(\'material\')">ğŸ“¦ìì¬</button><button class="tab" onclick="setTab(\'transaction\')">ğŸ’°ê±°ë˜</button></div><div class="search-box"><input class="search-input" placeholder="ğŸ” ë¹Œë¼" value="'+srch+'" oninput="srch=this.value" onkeypress="if(event.key===\'Enter\')render()"></div><div style="padding:12px"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="font-weight:600;color:#00695c">ë¹Œë¼ ('+fv.length+')</span><button class="btn btn-orange btn-sm" onclick="goVillaForm()">+ ì¶”ê°€</button></div><div class="villa-grid">'+fv.map(v=>'<button class="villa-btn '+(selV?.id===v.id?'active':'')+'" onclick="selectV(\''+v.id+'\')">'+v.name+'</button>').join('')+'</div></div>'+(selV?'<div class="card"><div class="card-header"><span>'+selV.name+'</span><div><button class="btn btn-blue btn-sm" onclick="editVilla(\''+selV.id+'\')">ìˆ˜ì •</button><button class="btn btn-green btn-sm" onclick="goUnitForm(\''+selV.id+'\')">+í˜¸ìˆ˜</button></div></div><div style="background:#f5f5f5;padding:12px;font-size:13px">'+(selV.address?'<div style="color:#1565c0;cursor:pointer" onclick="openMap(\''+selV.address+'\')">ğŸ“ '+selV.address+'</div>':'')+'<div>ğŸ‘¤ '+(selV.ownerPhone?'<a href="tel:'+selV.ownerPhone+'">'+selV.ownerPhone+'</a>':'-')+'</div></div><div class="card-body" style="padding:8px"><table style="width:100%;border-collapse:collapse"><thead><tr style="background:#607d8b;color:#fff"><th style="padding:10px;text-align:left">í˜¸ìˆ˜</th><th style="padding:10px;text-align:left">ì„¸ì…ì</th><th style="padding:10px">ê´€ë¦¬</th></tr></thead><tbody>'+(vu.length?vu.map(u=>'<tr style="border-bottom:1px solid #eee"><td style="padding:10px"><span class="unit-num '+(u.isEmpty?'empty':'')+'">'+u.unit+(u.isEmpty?' ê³µ':'')+'</span></td><td style="padding:10px"><div style="font-weight:600">'+(u.tenant||'-')+'</div>'+(u.phone?'<a href="tel:'+u.phone+'" style="font-size:12px;color:#1565c0">'+u.phone+'</a>':'')+'</td><td style="padding:10px;text-align:center"><button class="btn btn-blue btn-sm" onclick="viewUnit(\''+u.id+'\')">ìƒì„¸</button><button class="btn btn-sm" style="background:#9e9e9e;color:#fff" onclick="editUnit(\''+u.id+'\')">ìˆ˜ì •</button></td></tr>').join(''):'<tr><td colspan="3" style="text-align:center;padding:20px;color:#999">ì—†ìŒ</td></tr>')+'</tbody></table></div></div>':'')}
function renderMat(app){const sp=getSup();let f=[...mats];if(supF!=='all')f=f.filter(m=>m.supplier===supF);if(srch)f=f.filter(m=>(m.name||'').toLowerCase().includes(srch.toLowerCase()));app.innerHTML='<div class="header"><h1 style="font-size:20px">ğŸ  ë¹Œë¼ê´€ë¦¬</h1></div><div class="tabs"><button class="tab" onclick="setTab(\'as\')">ğŸ”§A/S</button><button class="tab" onclick="setTab(\'villa\')">ğŸ¢ë¹Œë¼</button><button class="tab active" onclick="setTab(\'material\')">ğŸ“¦ìì¬</button><button class="tab" onclick="setTab(\'transaction\')">ğŸ’°ê±°ë˜</button></div><div class="search-box"><input class="search-input" placeholder="ğŸ” í’ˆëª©" value="'+srch+'" oninput="srch=this.value" onkeypress="if(event.key===\'Enter\')render()"></div><div style="padding:12px"><div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>ì´ <b>'+f.length+'</b>ê°œ</span><button class="btn btn-orange btn-sm" onclick="goMatForm()">+ ì¶”ê°€</button></div>'+(sp.length?'<div style="margin-bottom:12px"><div class="villa-grid"><button class="filter-btn '+(supF==='all'?'active':'')+'" onclick="supF=\'all\';render()">ì „ì²´</button>'+sp.map(s=>'<button class="filter-btn '+(supF===s?'active':'')+'" onclick="supF=\''+s+'\';render()">'+s+'</button>').join('')+'</div></div>':'')+'</div><div class="card" style="margin-top:0"><div class="card-body">'+(f.length?f.map(m=>'<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eee"><div><div style="font-weight:600">'+m.name+(m.supplier?'<span class="supplier-badge">'+m.supplier+'</span>':'')+'</div><div style="font-size:13px;color:#666">êµ¬ì… <b>'+(m.price||0).toLocaleString()+'</b> â†’ ì²­êµ¬ <b>'+(m.chargePrice||0).toLocaleString()+'</b></div></div><button class="btn btn-blue btn-sm" onclick="editMat(\''+m.id+'\')">ìˆ˜ì •</button></div>').join(''):'<div class="empty">ì—†ìŒ</div>')+'</div></div>'}
function renderUnitDetail(app){const u=selU;if(!u){goBack();return}const v=villas.find(v=>v.id===u.villaId),vn=v?.name||'',ur=repairs.filter(r=>r.villaName===vn&&r.unit===u.unit).sort((a,b)=>(b.receiveDate||'').localeCompare(a.receiveDate||'')),ut=txs.filter(t=>t.type==='sell'&&t.villaName===vn&&t.unit===u.unit),pt=moveH.filter(h=>h.villaId===u.villaId&&h.unit===u.unit);app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>'+vn+' '+u.unit+'í˜¸</span></div><div style="padding:16px"><div class="card"><div class="card-header"><span>ì •ë³´</span><div><button class="btn btn-blue btn-sm" onclick="editUnit(\''+u.id+'\')">ìˆ˜ì •</button>'+(!u.isEmpty&&u.tenant?'<button class="btn btn-orange btn-sm" onclick="moveOut(\''+u.id+'\')">ì´ì‚¬ì •ì‚°</button>':'')+'</div></div><div class="card-body"><div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee"><span>ìƒíƒœ</span><span class="'+(u.isEmpty?'unpaid-badge':'paid-badge')+'">'+(u.isEmpty?'ê³µì‹¤':'ì…ì£¼')+'</span></div><div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee"><span>ì„¸ì…ì</span><span style="font-weight:600">'+(u.tenant||'-')+'</span></div><div style="display:flex;justify-content:space-between;padding:8px 0"><span>ì—°ë½ì²˜</span><span>'+(u.phone?'<a href="tel:'+u.phone+'">'+u.phone+'</a>':'-')+'</span></div></div></div><div class="card"><div class="card-header">ğŸ“‹ A/S ('+ur.length+')</div><div class="card-body">'+(ur.length?ur.map(r=>'<div style="background:#f5f5f5;padding:10px;border-radius:8px;margin-bottom:8px;font-size:13px"><div style="color:#666;font-size:11px">'+r.receiveDate+' <span class="status-badge '+(r.status==='ì™„ë£Œ'?'done':'pending')+'">'+r.status+'</span></div><div>'+r.description+'</div></div>').join(''):'<div class="empty">ì—†ìŒ</div>')+'</div></div><div class="card"><div class="card-header">ğŸ’° ì²­êµ¬ ('+ut.length+')</div><div class="card-body">'+(ut.length?ut.map(t=>'<div style="background:#f5f5f5;padding:10px;border-radius:8px;margin-bottom:8px;font-size:13px"><div style="color:#666;font-size:11px">'+t.date+' <span class="'+(t.isPaid?'paid-badge':'unpaid-badge')+'">'+(t.isPaid?'ë‚©ë¶€':'ë¯¸ë‚©')+'</span></div><div>'+t.itemName+' '+(t.chargeAmount||0).toLocaleString()+'ì›</div></div>').join(''):'<div class="empty">ì—†ìŒ</div>')+'</div></div></div>'}
function renderASForm(app){const d=ed||{villaName:'',unit:'',description:'',receiveDate:today,status:'ë¯¸ê²°',phone:'',ownerPhone:'',address:'',visitTime:''};const vn=[...new Set(villas.map(v=>v.name))].sort(),sv=villas.find(v=>v.name===d.villaName),vu=sv?units.filter(u=>u.villaId===sv.id).sort((a,b)=>(+a.unit||0)-(+b.unit||0)):[];app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>'+(ed?.id?'ìˆ˜ì •':'ì ‘ìˆ˜')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">ì ‘ìˆ˜ì¼</label><input type="date" class="form-input" id="fDate" value="'+d.receiveDate+'"></div><div class="form-group"><label class="form-label">ì‹œê°„</label><div style="display:flex;gap:8px;margin-bottom:8px"><button type="button" class="villa-btn" onclick="addTime(\'ì˜¤ì „\')">ì˜¤ì „</button><button type="button" class="villa-btn" onclick="addTime(\'ì˜¤í›„\')">ì˜¤í›„</button><button type="button" class="villa-btn" onclick="addTime(\'ë¯¸ì •\')">ë¯¸ì •</button></div><input class="form-input" id="fTime" value="'+(d.visitTime||'')+'"></div><div class="form-group"><label class="form-label">ë¹Œë¼ *</label>'+(vn.length?'<div class="villa-grid">'+vn.map(v=>'<button type="button" class="villa-btn '+(d.villaName===v?'active':'')+'" onclick="selVAS(\''+v+'\')">'+v+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fVilla" value="'+d.villaName+'"></div><div class="form-group"><label class="form-label">ì£¼ì†Œ</label><input class="form-input" id="fAddr" value="'+(d.address||sv?.address||'')+'"></div><div class="form-group"><label class="form-label">í˜¸ìˆ˜ *</label>'+(vu.length?'<div class="villa-grid">'+vu.map(u=>'<button type="button" class="villa-btn '+(d.unit===u.unit?'active':'')+'" onclick="selUAS(\''+u.unit+'\',\''+(u.phone||'')+'\')">'+u.unit+(u.isEmpty?' ê³µ':'')+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fUnit" value="'+d.unit+'"></div><div class="form-group"><label class="form-label">ë‚´ìš© *</label><textarea class="form-input" id="fDesc">'+d.description+'</textarea></div><div class="row-2"><div class="form-group"><label class="form-label">ì„¸ì…ì</label><input class="form-input" id="fPhone" value="'+d.phone+'"></div><div class="form-group"><label class="form-label">ê±´ë¬¼ì£¼</label><input class="form-input" id="fOwner" value="'+(d.ownerPhone||sv?.ownerPhone||'')+'"></div></div><div class="form-group"><label class="form-label">ìƒíƒœ</label><div class="status-select"><button type="button" class="status-option '+(d.status==='ë¯¸ê²°'?'active':'')+'" onclick="setFmSt(\'ë¯¸ê²°\')">ë¯¸ê²°</button><button type="button" class="status-option '+(d.status==='ì™„ë£Œ'?'active':'')+'" onclick="setFmSt(\'ì™„ë£Œ\')">ì™„ë£Œ</button></div></div><button class="btn btn-orange btn-block" onclick="saveRep()">'+(ed?.id?'ìˆ˜ì •':'ì ‘ìˆ˜')+'</button></div></div></div>'}
function renderVillaForm(app){const d=ed||{name:'',address:'',ownerPhone:''};app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>'+(ed?.id?'ìˆ˜ì •':'ì¶”ê°€')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">ë¹Œë¼ëª… *</label><input class="form-input" id="fVName" value="'+d.name+'"></div><div class="form-group"><label class="form-label">ì£¼ì†Œ</label><input class="form-input" id="fVAddr" value="'+(d.address||'')+'"></div><div class="form-group"><label class="form-label">ê±´ë¬¼ì£¼</label><input class="form-input" id="fVPhone" value="'+(d.ownerPhone||'')+'"></div><button class="btn btn-orange btn-block" onclick="saveVilla()">'+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</button></div></div></div>'}
function renderUnitForm(app){const d=ed||{unit:'',tenant:'',phone:'',moveIn:'',memo:'',isEmpty:false};app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>'+(ed?.id?'ìˆ˜ì •':'ì¶”ê°€')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">í˜¸ìˆ˜ *</label><input class="form-input" id="fUNum" value="'+d.unit+'"></div><div class="form-group"><label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="fUEmpty" '+(d.isEmpty?'checked':'')+' style="width:20px;height:20px"><span style="font-weight:600;color:#c62828">ê³µì‹¤</span></label></div><div class="form-group"><label class="form-label">ì„¸ì…ì</label><input class="form-input" id="fUTen" value="'+(d.tenant||'')+'"></div><div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="fUPhone" value="'+(d.phone||'')+'"></div><div class="form-group"><label class="form-label">ì…ì£¼ì¼</label><input type="date" class="form-input" id="fUMove" value="'+(d.moveIn||'')+'"></div><div class="form-group"><label class="form-label">ë©”ëª¨</label><textarea class="form-input" id="fUMemo">'+(d.memo||'')+'</textarea></div><button class="btn btn-orange btn-block" onclick="saveUnit()">'+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</button>'+(ed?.id?'<button class="btn btn-red btn-block" style="margin-top:10px" onclick="delUnit(\''+ed.id+'\')">ì‚­ì œ</button>':'')+'</div></div></div>'}
function renderMatForm(app){const d=ed||{name:'',price:'',chargePrice:'',supplier:''},sp=getSup();app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>'+(ed?.id?'ìˆ˜ì •':'ì¶”ê°€')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">í’ˆëª© *</label><input class="form-input" id="fMName" value="'+(d.name||'')+'"></div><div class="form-group"><label class="form-label">êµ¬ì…ì²˜</label>'+(sp.length?'<div class="villa-grid" style="margin-bottom:8px">'+sp.map(s=>'<button type="button" class="villa-btn" onclick="document.getElementById(\'fMSup\').value=\''+s+'\'">'+s+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fMSup" value="'+(d.supplier||'')+'"></div><div class="row-2"><div class="form-group"><label class="form-label">êµ¬ì…ê°€</label><input type="number" class="form-input" id="fMPrice" value="'+(d.price||'')+'"></div><div class="form-group"><label class="form-label">ì²­êµ¬ê°€</label><input type="number" class="form-input" id="fMCharge" value="'+(d.chargePrice||'')+'"></div></div><button class="btn btn-orange btn-block" onclick="saveMat()">'+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</button>'+(ed?.id?'<button class="btn btn-red btn-block" style="margin-top:10px" onclick="delMat(\''+ed.id+'\')">ì‚­ì œ</button>':'')+'</div></div></div>'}
function renderTxBuyForm(app){const d=ed||{date:today,itemName:'',supplier:'',qty:1,unitPrice:''},items=[...new Set([...mats.map(m=>m.name),...txs.map(t=>t.itemName)])].filter(Boolean).sort(),sp=getSup();app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>êµ¬ë§¤ '+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="fTDate" value="'+d.date+'"></div><div class="form-group"><label class="form-label">í’ˆëª© *</label>'+(items.length?'<div class="villa-grid" style="margin-bottom:8px">'+items.slice(0,15).map(n=>'<button type="button" class="villa-btn" onclick="document.getElementById(\'fTItem\').value=\''+n+'\'">'+n+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fTItem" value="'+d.itemName+'"></div><div class="form-group"><label class="form-label">êµ¬ì…ì²˜</label>'+(sp.length?'<div class="villa-grid" style="margin-bottom:8px">'+sp.map(s=>'<button type="button" class="villa-btn" onclick="document.getElementById(\'fTSup\').value=\''+s+'\'">'+s+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fTSup" value="'+(d.supplier||'')+'"></div><div class="row-2"><div class="form-group"><label class="form-label">ìˆ˜ëŸ‰ *</label><input type="number" class="form-input" id="fTQty" value="'+d.qty+'"></div><div class="form-group"><label class="form-label">ë‹¨ê°€ *</label><input type="number" class="form-input" id="fTPrice" value="'+(d.unitPrice||'')+'"></div></div><button class="btn btn-blue btn-block" onclick="saveTxBuy()">'+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</button></div></div></div>'}
function renderTxSellForm(app){const d=ed||{date:today,itemName:'',villaName:'',unit:'',qty:1,chargeAmount:'',chargeTarget:'ê±´ë¬¼ì£¼',isPaid:false},items=[...new Set([...mats.map(m=>m.name),...txs.map(t=>t.itemName)])].filter(Boolean).sort(),vn=villas.map(v=>v.name);app.innerHTML='<div class="back-header"><button class="back-btn" onclick="goBack()">â†</button><span>íŒë§¤ '+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</span></div><div style="padding:16px"><div class="card"><div class="card-body"><div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="fTDate" value="'+d.date+'"></div><div class="form-group"><label class="form-label">í’ˆëª© *</label>'+(items.length?'<div class="villa-grid" style="margin-bottom:8px">'+items.slice(0,15).map(n=>'<button type="button" class="villa-btn" onclick="document.getElementById(\'fTItem\').value=\''+n+'\'">'+n+'</button>').join('')+'</div>':'')+'<input class="form-input" id="fTItem" value="'+d.itemName+'"></div><div class="row-2"><div class="form-group"><label class="form-label">ë¹Œë¼ *</label><select class="form-select" id="fTVilla"><option value="">ì„ íƒ</option>'+vn.map(v=>'<option value="'+v+'" '+(d.villaName===v?'selected':'')+'>'+v+'</option>').join('')+'</select></div><div class="form-group"><label class="form-label">í˜¸ìˆ˜ *</label><input class="form-input" id="fTUnit" value="'+d.unit+'"></div></div><div class="row-2"><div class="form-group"><label class="form-label">ìˆ˜ëŸ‰ *</label><input type="number" class="form-input" id="fTQty" value="'+d.qty+'"></div><div class="form-group"><label class="form-label">ì²­êµ¬ê¸ˆì•¡</label><input type="number" class="form-input" id="fTCharge" value="'+(d.chargeAmount||'')+'"></div></div><div class="form-group"><label class="form-label">ì²­êµ¬ëŒ€ìƒ</label><div class="status-select"><button type="button" class="status-option '+(d.chargeTarget==='ê±´ë¬¼ì£¼'?'active':'')+'" onclick="document.querySelectorAll(\'.status-option\').forEach(e=>e.classList.remove(\'active\'));this.classList.add(\'active\')">ê±´ë¬¼ì£¼</button><button type="button" class="status-option '+(d.chargeTarget==='ì„¸ì…ì'?'active':'')+'" onclick="document.querySelectorAll(\'.status-option\').forEach(e=>e.classList.remove(\'active\'));this.classList.add(\'active\')">ì„¸ì…ì</button></div></div><div class="form-group"><label style="display:flex;align-items:center;gap:10px"><input type="checkbox" id="fTIsPaid" '+(d.isPaid?'checked':'')+' style="width:20px;height:20px"><span style="font-weight:600;color:#2e7d32">ë‚©ë¶€ì™„ë£Œ</span></label></div><button class="btn btn-orange btn-block" onclick="saveTxSell()">'+(ed?.id?'ìˆ˜ì •':'ë“±ë¡')+'</button></div></div></div>'}
function setTab(t){tab=t;pg='list';selV=null;selU=null;srch='';render()}
function setFlt(f){flt=f;render()}
function setSelD(d){selD=d;render()}
function goBack(){pg='list';ed=null;selU=null;render()}
function goASForm(){ed=null;fmSt='ë¯¸ê²°';pg='asForm';render()}
function goVillaForm(){ed=null;pg='villaForm';render()}
function goUnitForm(vid){ed={villaId:vid};pg='unitForm';render()}
function goMatForm(){ed=null;pg='matForm';render()}
function goTxBuyForm(){ed=null;pg='txBuyForm';render()}
function goTxSellForm(){ed=null;pg='txSellForm';render()}
function openQuickModal(){document.getElementById('quickModal').style.display='flex';document.getElementById('quickInput').focus()}
function closeQuickModal(){document.getElementById('quickModal').style.display='none'}
function openQuickBuyModal(){document.getElementById('quickBuyModal').style.display='flex';document.getElementById('quickBuyInput').focus()}
function closeQuickBuyModal(){document.getElementById('quickBuyModal').style.display='none'}
function openTodayMap(){const t=repairs.filter(r=>r.receiveDate===today&&r.status==='ë¯¸ê²°'&&r.address);if(!t.length)return alert('ì£¼ì†Œ ì—†ìŒ');alert('ğŸ“ ì˜¤ëŠ˜\n\n'+t.map((r,i)=>(i+1)+'. '+r.villaName+' '+r.unit+'í˜¸ - '+r.address).join('\n'));openMap(t[0].address)}
function setFmSt(s){fmSt=s;document.querySelectorAll('.status-option').forEach(e=>{e.classList.remove('active');if(e.textContent===s)e.classList.add('active')})}
function addTime(t){const i=document.getElementById('fTime');i.value=i.value?i.value+' '+t:t}
function selVAS(n){document.getElementById('fVilla').value=n;const v=villas.find(v=>v.name===n);if(v?.address)document.getElementById('fAddr').value=v.address;if(v?.ownerPhone)document.getElementById('fOwner').value=v.ownerPhone;ed=ed||{};ed.villaName=n;render()}
function selUAS(u,p){document.getElementById('fUnit').value=u;if(p)document.getElementById('fPhone').value=p}
function selectV(id){selV=villas.find(v=>v.id===id);render()}
function viewUnit(id){selU=units.find(u=>u.id===id);pg='unitDetail';render()}
function editVilla(id){ed=villas.find(v=>v.id===id);pg='villaForm';render()}
function editUnit(id){ed={...units.find(u=>u.id===id)};pg='unitForm';render()}
function editRep(id){ed=repairs.find(r=>r.id===id);fmSt=ed?.status||'ë¯¸ê²°';pg='asForm';render()}
function editMat(id){ed=mats.find(m=>m.id===id);pg='matForm';render()}
function editTx(id){ed=txs.find(t=>t.id===id);pg=ed.type==='buy'?'txBuyForm':'txSellForm';render()}
async function submitQuick(){const t=document.getElementById('quickInput').value.trim();if(!t)return alert('ì…ë ¥');const r=parseQ(t);if(!confirm('ë¹Œë¼: '+(r.vn||'?')+'\ní˜¸ìˆ˜: '+(r.u||'?')+'\nì‹œê°„: '+(r.vt||'-')+'\në‚´ìš©: '+(r.d||'?')+'\n\në“±ë¡?'))return;let v=villas.find(v=>v.name===r.vn);if(!v&&r.vn)await db.collection('villas').doc('v_'+Date.now()).set({name:r.vn,address:'',ownerPhone:''});if(r.u){const vid=v?.id||'v_'+Date.now();if(!units.find(u=>u.villaId===vid&&u.unit===r.u))await db.collection('units').doc('u_'+Date.now()).set({villaId:vid,unit:r.u,tenant:'',phone:'',moveIn:'',memo:'',isEmpty:false})}await db.collection('repairs').doc('r_'+Date.now()).set({villaName:r.vn,unit:r.u,description:r.d,visitTime:r.vt||'',receiveDate:today,status:'ë¯¸ê²°',phone:'',ownerPhone:'',address:'',workMemo:'',photos:[]});alert('âœ…');document.getElementById('quickInput').value='';closeQuickModal()}
function parseQ(t){let vn='',u='',vt='',d='';const tm=t.match(/(ì˜¤ì „|ì˜¤í›„|ë¯¸ì •)(\s*\d{1,2}ì‹œ)?/);if(tm){vt=tm[0];t=t.replace(tm[0],' ')}const um=t.match(/(\d+)\s*í˜¸?/);if(um){u=um[1];t=t.replace(um[0],' ')}const sv=[...villas].sort((a,b)=>(b.name?.length||0)-(a.name?.length||0));for(const v of sv)if(v.name&&t.includes(v.name)){vn=v.name;t=t.replace(v.name,' ');break}if(!vn){const w=t.trim().split(/\s+/);if(w.length){vn=w[0];t=w.slice(1).join(' ')}}d=t.trim();return{vn,u,vt,d}}
async function saveRep(){const vn=document.getElementById('fVilla').value.trim(),u=document.getElementById('fUnit').value.trim(),de=document.getElementById('fDesc').value.trim(),rd=document.getElementById('fDate').value,ph=document.getElementById('fPhone').value.trim(),op=document.getElementById('fOwner').value.trim(),ad=document.getElementById('fAddr').value.trim(),vt=document.getElementById('fTime').value.trim();if(!vn||!u||!de)return alert('í•„ìˆ˜');let ev=villas.find(v=>v.name===vn);if(!ev){await db.collection('villas').doc('v_'+Date.now()).set({name:vn,address:ad,ownerPhone:op});ev={id:'v_'+Date.now()}}if(!units.find(x=>x.villaId===ev.id&&x.unit===u))await db.collection('units').doc('u_'+Date.now()).set({villaId:ev.id,unit:u,tenant:'',phone:ph,moveIn:'',memo:'',isEmpty:false});const data={villaName:vn,unit:u,description:de,receiveDate:rd,phone:ph,ownerPhone:op,address:ad,visitTime:vt,status:fmSt};if(ed?.id)await db.collection('repairs').doc(ed.id).update(data);else await db.collection('repairs').doc('r_'+Date.now()).set({...data,workMemo:'',photos:[]});ed=null;fmSt='ë¯¸ê²°';pg='list';render()}
async function togSt(id){const r=repairs.find(r=>r.id===id);if(r)await db.collection('repairs').doc(id).update({status:r.status==='ì™„ë£Œ'?'ë¯¸ê²°':'ì™„ë£Œ'})}
async function delRep(id){if(confirm('ì‚­ì œ?'))await db.collection('repairs').doc(id).delete()}
async function saveVilla(){const n=document.getElementById('fVName').value.trim(),a=document.getElementById('fVAddr').value.trim(),p=document.getElementById('fVPhone').value.trim();if(!n)return alert('í•„ìˆ˜');if(ed?.id)await db.collection('villas').doc(ed.id).update({name:n,address:a,ownerPhone:p});else await db.collection('villas').doc('v_'+Date.now()).set({name:n,address:a,ownerPhone:p});ed=null;pg='list';render()}
async function saveUnit(){const u=document.getElementById('fUNum').value.trim(),t=document.getElementById('fUTen').value.trim(),p=document.getElementById('fUPhone').value.trim(),m=document.getElementById('fUMove').value,me=document.getElementById('fUMemo').value.trim(),e=document.getElementById('fUEmpty').checked;if(!u)return alert('í•„ìˆ˜');if(ed?.id)await db.collection('units').doc(ed.id).update({unit:u,tenant:t,phone:p,moveIn:m,memo:me,isEmpty:e});else await db.collection('units').doc('u_'+Date.now()).set({unit:u,tenant:t,phone:p,moveIn:m,memo:me,isEmpty:e,villaId:ed.villaId});ed=null;pg='list';render()}
async function delUnit(id){if(confirm('ì‚­ì œ?')){await db.collection('units').doc(id).delete();goBack()}}
async function moveOut(id){const u=units.find(u=>u.id===id);if(!u)return;const v=villas.find(v=>v.id===u.villaId),vn=v?.name||'',m=prompt('ì •ì‚° ë‚´ìš©:');if(m===null)return;await db.collection('moveOutHistory').doc('h_'+Date.now()).set({villaId:u.villaId,villaName:vn,unit:u.unit,tenant:u.tenant,phone:u.phone,moveIn:u.moveIn,moveOut:today,settlementMemo:m});await db.collection('units').doc(id).update({tenant:'',phone:'',moveIn:'',isEmpty:true,memo:'[ì „:'+u.tenant+'] '+m});alert('âœ…');goBack()}
async function saveMat(){const n=document.getElementById('fMName').value.trim(),s=document.getElementById('fMSup').value.trim(),p=parseInt(document.getElementById('fMPrice').value)||0,c=parseInt(document.getElementById('fMCharge').value)||0;if(!n)return alert('í•„ìˆ˜');if(ed?.id)await db.collection('materials').doc(ed.id).update({name:n,supplier:s,price:p,chargePrice:c});else await db.collection('materials').doc('m_'+Date.now()).set({name:n,supplier:s,price:p,chargePrice:c,unitEa:''});ed=null;pg='list';render()}
async function delMat(id){if(confirm('ì‚­ì œ?')){await db.collection('materials').doc(id).delete();goBack()}}
async function saveTxBuy(){const d=document.getElementById('fTDate').value,n=document.getElementById('fTItem').value.trim(),s=document.getElementById('fTSup').value.trim(),q=parseInt(document.getElementById('fTQty').value)||0,p=parseInt(document.getElementById('fTPrice').value)||0;if(!n||!q)return alert('í•„ìˆ˜');if(ed?.id)await db.collection('transactions').doc(ed.id).update({date:d,itemName:n,supplier:s,qty:q,unitPrice:p,totalPrice:q*p});else await db.collection('transactions').doc('tx_'+Date.now()).set({type:'buy',date:d,itemName:n,supplier:s,qty:q,unitPrice:p,totalPrice:q*p});await updMatP(n,s,p);ed=null;pg='list';render()}
async function saveTxSell(){const d=document.getElementById('fTDate').value,n=document.getElementById('fTItem').value.trim(),vn=document.getElementById('fTVilla').value,u=document.getElementById('fTUnit').value.trim(),q=parseInt(document.getElementById('fTQty').value)||0,c=parseInt(document.getElementById('fTCharge').value)||0,ct=document.querySelector('.status-option.active')?.textContent||'ê±´ë¬¼ì£¼',p=document.getElementById('fTIsPaid').checked;if(!n||!vn||!u||!q)return alert('í•„ìˆ˜');if(ed?.id)await db.collection('transactions').doc(ed.id).update({date:d,itemName:n,villaName:vn,unit:u,qty:q,chargeAmount:c,chargeTarget:ct,isPaid:p});else await db.collection('transactions').doc('tx_'+Date.now()).set({type:'sell',date:d,itemName:n,villaName:vn,unit:u,qty:q,chargeAmount:c,chargeTarget:ct,isPaid:p});ed=null;pg='list';render()}
async function markPaid(id){if(confirm('ë‚©ë¶€?'))await db.collection('transactions').doc(id).update({isPaid:true})}
async function delTx(id){if(confirm('ì‚­ì œ?'))await db.collection('transactions').doc(id).delete()}
setTimeout(render,1000);
</script>
</body>
</html>
